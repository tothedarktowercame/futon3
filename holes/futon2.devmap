@multiarg futon2/devmap
@title FUTON2 Development Map ‚Äî Active Inference Engine & Ant Demonstrators
@audience futon-devs, simulation-agents, future-you
@tone formal-analytic
@style roadmap
@factor Energy (viriya)
@IFR: FUTON2 provides a narratable Active Inference engine whose ants are first
demonstrators for AIF agent species. The same engine powers futon3 fulab agents
and may drive futon5 MetaCA simulations‚Äîmaking FUTON2 the shared AIF substrate
that turns insight into kinetic practice across the stack.
@state Core AIF stack (observe‚Üíperceive‚Üíaffect‚Üípolicy‚Üíact) running end-to-end
with analyzer hooks. Observation property tests strong (440+ iterations).
Hunger/tau goldens recorded (6 scenarios). Policy goldens recorded (5 scenarios).
Microtraces locked (4 scenarios). Gaps: world mechanics contract undocumented;
external stepping API missing; futon1/futon3 bridges planned but not implemented.
@next Formalize world mechanics contract; expose external stepping API for
episode export; design futon1 graph adapter; expand policy goldens to 10 scenarios.

## The Argument

FUTON2 provides a narratable Active Inference engine with the ant war-game as its
first demonstrator. The AIF stack baseline documents the full pipeline‚Äîobserve,
perceive, affect, policy, act‚Äîwith locked parameters and golden microtraces so
the system behaves reproducibly across seeds and refactors. The observation layer
is hardened with property tests ensuring all sensory channels normalize to [0,1]
across hundreds of random worlds. The predictive coding microcycle produces
per-step traces of hunger, tau, and error evolution that regression tests lock
against golden scenarios. Hunger and precision dynamics have six golden sequences
covering normal operation through starvation, overstimulation, and cargo stress.
The policy layer surfaces EFE-based action rankings through a deterministic
harness with golden scenarios for forage, return, explore, and defend modes.
The world mechanics provide the environment contract that all agent behaviour
depends on. Pivot streams and analyzers enable introspection, feeding metrics
to higher futons. An external stepping API will let futon3 and futon5 drive
episodes programmatically. Bridges to futon1 graph memory and futon3 proofwork
will let AIF agents read fact graphs and contribute to shared missions. Viriya
metrics will connect simulation dynamics to social activation, making FUTON2
a practice accelerator rather than a curiosity.


! instantiated-by: Prototype 0 ‚Äî AIF Stack Baseline [üåù/Âõõ üóø/Âàä]
  :maturity :active
  :depends-on []
  :evidence-for-active [Stack running end-to-end for 90+ days; 4 golden microtraces locked; parameters documented]

  + context: FUTON2 runs a full Active Inference loop in the ant war-game.
  + IF: You want a stable story showing how observation, prediction errors, precision, and actions integrate per tick
  + HOWEVER: Without a documented baseline, modules can drift and break silently
  + THEN: Capture top-level architecture (sensory keys through world updates), lock hunger and predictive micro-step parameters, and maintain golden AIF microtraces
  + BECAUSE: A documented baseline prevents accidental drift before optimising policy, analyzers, or mechanics

  + EVIDENCE:
    evidence[doc/stack-baseline.md documents 5-stage pipeline with locked parameters]
    evidence[src/ants/aif/core.clj orchestrates full tick via aif-step()]
    evidence[test/resources/goldens/microtraces.edn locks 4 golden perception traces]
    evidence[doc/trace/single_tick.edn + SVG provide deterministic trace artifacts]

  + NEXT-STEPS:
    next[Add doc/trace-semantics.md explaining micro-step semantics]
    next[Document hunger-tau coupling (when update-tau fires vs perceive-internal updates)]
    next[Add 4 complete tick traces with commentary (forage, return, explore, defend)]

  :success-criteria
    pass[Golden microtraces pass regression tests]
    pass[Parameters locked in stack-baseline.md]
    pass[New modules can integrate without breaking existing traces]
    fail[Microtrace regression without version bump or migration]

  :psr-example "Selected AIF stack baseline for fulab integration because it's the reference AIF implementation"
  :pur-template "AIF tick {{tick-id}}, perception steps: {{steps}}, final tau: {{tau}}"


! instantiated-by: Prototype 1 ‚Äî Observation Layer Hardening [üåù/Âõõ üëé/Âàä]
  :maturity :active
  :depends-on [f2/P0]
  :evidence-for-active [440+ property test iterations; 14-channel vector ABI locked]

  + context: g-observe normalises sensory evidence into vectors for downstream processing.
  + IF: You want deterministic observations across seeds and a nailed-down vector ABI
  + HOWEVER: Without property tests, normalisation bounds and edge cases can break silently
  + THEN: Enforce 0‚Äì1 ranges via property tests, document sense‚Üívector ordering, and test edge cases (borders, degenerate fields)
  + BECAUSE: Reliable observations keep perception and policy stable across world configurations

  + EVIDENCE:
    evidence[test/ants/aif/observe_test.clj runs 200+ random worlds with g-observe-values-clamped]
    evidence[120 iterations test border/corner neighbor calculations]
    evidence[Degenerate field test handles max-food=0 gracefully]
    evidence[14-element vector ABI locked in sense-vector-ordering test]

  + NEXT-STEPS:
    next[Add doc/observation-spec.md listing all normalization bounds]
    next[Add white-space detection property tests (:white? field currently untested)]
    next[Update README.md observation vector docs (lists 13, actual is 14)]

  :success-criteria
    pass[All sensory channels return values in [0,1]]
    pass[Vector ABI stable across refactors]
    pass[Edge cases (borders, empty fields) handled correctly]
    fail[Observation varies non-deterministically for same input]

  :psr-example "Selected observation hardening for ML export because deterministic vectors are prerequisite"
  :pur-template "Observation test run, iterations: {{count}}, channels: 14, all clamped: {{yes|no}}"


! instantiated-by: Prototype 2 ‚Äî Predictive Coding Microcycle [üôá/‰π° üì§/Âèâ]
  :maturity :active
  :depends-on [f2/P0]
  :evidence-for-active [4 golden scenarios locked; regression tests pass; trace tooling operational]

  + context: Perception performs multi-step updates of mu, tau, Pi-o, goals, and weighted errors.
  + IF: Inspectors or future bridges need to understand belief updates
  + HOWEVER: Without canonical traces, hunger updates and error accumulation are opaque
  + THEN: Publish single-tick perception traces with per-step hunger, tau, and error; lock against golden scenarios
  + BECAUSE: Clear cycles make integrations with futon4 symbolic memory and futon3 fulab far easier

  + EVIDENCE:
    evidence[test/resources/goldens/microtraces.edn has 4 golden scenarios with per-step traces]
    evidence[test/ants/aif/microtrace_regression_test.clj compares live runs to goldens]
    evidence[tools/trace_tick.clj generates doc/trace/single_tick.edn + SVG]
    evidence[src/ants/aif/perceive.clj outputs {tau, h, error} per micro-step]

  + NEXT-STEPS:
    next[Add doc/trace-semantics.md formalizing micro-step semantics]
    next[Document goal-bias mechanism (blending toward home/enemy based on cargo)]
    next[Explain why errors are 0.0 in certain goldens]

  :success-criteria
    pass[Golden scenarios pass regression tests]
    pass[Traces show tau, h, error evolution per step]
    pass[External tools can extract mu/precision snapshots]
    fail[Perception output varies for same input and config]

  :psr-example "Selected predictive coding traces for fulab agent debugging because step-by-step visibility is essential"
  :pur-template "Microtrace scenario {{name}}, steps: {{count}}, final tau: {{tau}}, final h: {{h}}"


! instantiated-by: Prototype 3 ‚Äî Hunger & Precision Dynamics [üí´/ÂÖ≠ üôá/Âèâ]
  :maturity :active
  :depends-on [f2/P0]
  :evidence-for-active [6 golden sequences locked; regression tests pass]

  + context: tick-hunger, update-hunger, update-tau, and modulate-precisions control the most sensitive dynamics.
  + IF: Affective behaviour must survive refactors reproducibly
  + HOWEVER: Without goldens, tau evolution and hunger saturation can drift
  + THEN: Record golden sequences for key scenarios (normal, starvation, overstimulation, heavy-cargo, high-risk, high-ingest) and lock expected tau floors/caps
  + BECAUSE: Once goldens exist, small tune-ups stop breaking entire colony behaviour

  + EVIDENCE:
    evidence[test/resources/goldens/hunger_tau.edn has 6 golden sequences as specified]
    evidence[test/ants/aif/hunger_regression_test.clj runs all 6 scenarios through full affect pipeline]
    evidence[tools/hunger_goldens.clj generates golden file deterministically]
    evidence[README.md documents hunger config parameters and defaults]

  + NEXT-STEPS:
    next[Add doc/hunger-goldens-guide.md explaining behavioral regime each scenario represents]
    next[Generate SVG plots for hunger_tau trajectories]
    next[Add tau-floor/tau-cap assertions to regression test]
    next[Add boundary saturation tests (h=0.99 + delta ‚Üí clamps to 1.0)]

  :success-criteria
    pass[All 6 golden scenarios pass regression tests]
    pass[Tau floors and caps behave as documented]
    pass[Hunger saturation clamps correctly at boundaries]
    fail[Affective dynamics change without golden update]

  :psr-example "Selected hunger goldens for refactor safety because affect dynamics are most sensitive to drift"
  :pur-template "Hunger scenario {{name}}, h: {{h_start}}‚Üí{{h_end}}, tau: {{tau}}"


! instantiated-by: Prototype 4 ‚Äî Policy Layer Harness [üç≤/‰π° üî•/‰ª£]
  :maturity :active
  :depends-on [f2/P0, f2/P2, f2/P3]
  :evidence-for-active [5 golden scenarios locked; deterministic eval-policy function operational]

  + context: ants.aif.policy selects actions using EFE metrics.
  + IF: Policy choices must be reproducible under controlled inputs
  + HOWEVER: Without a standalone harness, policy testing requires full sim runs
  + THEN: Provide eval-policy harness that accepts synthetic mu/observation pairs; lock golden action rankings for canonical scenarios
  + BECAUSE: Stabilised policies are mandatory before benchmarking or bridging into futon1 salience services

  + EVIDENCE:
    evidence[test/resources/goldens/policy_harness.edn has 5 golden scenarios with action rankings]
    evidence[tools/policy_harness.clj generates canonical scenarios]
    evidence[test/ants/aif/policy_harness_test.clj compares rankings to golden]
    evidence[test/ants/aif/policy_test.clj has comprehensive behavioral tests]

  + NEXT-STEPS:
    next[Expand to 10 canonical scenarios as specified]
    next[Document EFE component formulas in doc/policy-spec.md]
    next[Add policy response time instrumentation]

  :success-criteria
    pass[eval-policy produces deterministic rankings for same inputs]
    pass[Golden scenarios cover forage, return, explore, defend modes]
    pass[Policy changes require golden updates with rationale]
    fail[Action rankings vary non-deterministically]

  :psr-example "Selected policy harness for fulab agent validation because reproducible decisions enable debugging"
  :pur-template "Policy eval scenario {{name}}, top action: {{action}}, G: {{G}}"


! instantiated-by: Prototype 5 ‚Äî World Mechanics Contract [üéë/‰π¶ üëï/Âäû]
  :maturity :greenfield
  :depends-on []
  :evidence-for-active [Contract documented; invariants tested; movement deterministic]

  + context: The simulator handles evaporation, movement, gather/deposit, pheromone dynamics, hunger propagation, and reserves.
  + IF: FUTON2 should be a reliable agent-environment backend
  + HOWEVER: Movement heuristics and gather thresholds are powerful yet lightly documented
  + THEN: Document all invariants (pheromone caps, grid bounds, gather limits), seed movement for determinism, and split movement modes into testable units
  + BECAUSE: A clear contract keeps the world trustworthy when other prototypes depend on it for episodes

  + EVIDENCE:
    evidence[war.clj implements full world mechanics]
    evidence[Basic simulation runs deterministically with fixed seeds]

  + NEXT-STEPS:
    next[Document pheromone caps, grid bounds, gather limits in doc/world-contract.md]
    next[Add property tests for movement determinism]
    next[Split movement modes into testable units]
    next[Document white-streak rules]

  :success-criteria
    pass[World invariants documented and tested]
    pass[Movement deterministic for same seed]
    pass[Gather/deposit thresholds explicit and tested]
    fail[World state drifts non-deterministically]

  :psr-example "Selected world contract for episode export because external consumers need guaranteed semantics"
  :pur-template "World step {{tick}}, ants: {{count}}, food: {{food}}, pheromone max: {{pher}}"


! instantiated-by: Prototype 6 ‚Äî Pivot Stream & Analyzer [üö¢/Â∑≤ üê≤/Êó†]
  :maturity :greenfield
  :depends-on [f2/P0]
  :evidence-for-active [Schema versioned; required keys tested; futon3/futon4 can subscribe]

  + context: The live analyzer consumes pivot events, computes EWMA metrics, and detects starvation spirals.
  + IF: Analyzer outputs should feed futon3 evaluations or futon4 reflexive agents
  + HOWEVER: Pivot schemas are implicit and analyzer assumptions undocumented
  + THEN: Freeze versioned pivot-row schema, test required keys, and ship example analyzer plugin
  + BECAUSE: Pivot streams are FUTON2's event bus and must behave like a stable ABI

  + EVIDENCE:
    evidence[Live analyzer operational in war.clj]
    evidence[Pivot events emitted per tick]

  + NEXT-STEPS:
    next[Freeze pivot-row schema in doc/pivot-schema.md]
    next[Add tests for required keys (:act, :mode, :cargo, :ing, etc.)]
    next[Ship example analyzer plugin for futon4]
    next[Document EWMA metric calculations]

  :success-criteria
    pass[Pivot schema versioned and stable]
    pass[Required keys validated on emit]
    pass[External consumers can subscribe without internal knowledge]
    fail[Schema changes break downstream consumers]

  :psr-example "Selected pivot schema for futon4 integration because event bus stability enables composition"
  :pur-template "Pivot batch {{batch}}, events: {{count}}, schema version: {{version}}"


! instantiated-by: Prototype 7 ‚Äî External Stepping API [üì§/‰∫à üö¢/Â∑≤]
  :maturity :greenfield
  :depends-on [f2/P5, f2/P6]
  :evidence-for-active [futon2.step function exposed; EDN episode export working]

  + context: simulate drives the war sim but offers no external stepping API.
  + IF: futon3 fulab or futon5 MetaCA want to request "give me N steps with this config"
  + HOWEVER: Stepping remains tied to CLI and HUD
  + THEN: Expose (futon2.step world n {:emit-pivot? true}), add EDN exports of full episodes
  + BECAUSE: Exported episodes are critical for agent training, memory, and pattern extraction

  + EVIDENCE:
    evidence[simulate function exists in war.clj]
    evidence[Basic stepping possible via REPL]

  + NEXT-STEPS:
    next[Expose futon2.step as public API]
    next[Add EDN episode export with pivot batches]
    next[Document stepping API for futon3/futon5 consumers]
    next[Add episode replay capability]

  :success-criteria
    pass[External callers can step world programmatically]
    pass[Episodes exportable as EDN]
    pass[Pivot batches consistent across export]
    fail[Stepping requires internal knowledge or HUD]

  :psr-example "Selected stepping API for fulab because agents need programmatic episode control"
  :pur-template "Episode export {{id}}, steps: {{count}}, pivots: {{pivot_count}}"


! instantiated-by: Prototype 8 ‚Äî Benchmark Suite [üóø/‰∏â ‚ö°Ô∏è/ÂÜÖ]
  :maturity :greenfield
  :depends-on [f2/P7]
  :evidence-for-active [Parametrised benchmarks across grid sizes; golden CSVs captured]

  + context: Benchmark scripts compare classic ants to AIF runs across scores and durations.
  + IF: You want formal behavioural comparisons rather than anecdotes
  + HOWEVER: Only three preset scenarios exist with no variance analysis
  + THEN: Add parametrised benchmarks spanning grid sizes, pheromone decay, hunger burn, and tau floors; capture plots and golden CSVs
  + BECAUSE: FUTON2 should function as a scientific system with reproducible metrics

  + EVIDENCE:
    evidence[Basic benchmark scripts exist]
    evidence[Classic vs AIF comparison possible]

  + NEXT-STEPS:
    next[Parametrise benchmarks across grid sizes, decay rates, hunger burn]
    next[Add variance analysis across seeds]
    next[Capture golden CSVs for regression]
    next[Generate comparison plots]

  :success-criteria
    pass[Benchmarks parametrised and reproducible]
    pass[Classic vs AIF differences quantified]
    pass[Golden CSVs prevent silent regressions]
    fail[Benchmark results vary unexpectedly]

  :psr-example "Selected benchmark suite for AIF validation because claims need quantified evidence"
  :pur-template "Benchmark {{name}}, classic score: {{classic}}, AIF score: {{aif}}, delta: {{delta}}"


! instantiated-by: Prototype 9 ‚Äî futon1 Graph Adapter [üëé/Âàä üë≠/‰∫å]
  :maturity :greenfield
  :depends-on [f2/P6, f2/P7]
  :source [f1/P7 f1/P8]
  :evidence-for-active [Adapter converts percepts‚Üîgraph facts; colony run exports to futon1 salience]

  + context: FUTON1 offers graph-memory API; FUTON2 emits percept/action streams.
  + IF: Ants should be the first AIF agents that read fact graphs and write beliefs
  + HOWEVER: Percepts/actions are locked to grid coordinates with no mapping to futon1 entity IDs
  + THEN: Design bidirectional adapter (percepts‚Üígraph facts, graph cues‚Üípriors), version ABI, replay colony run that exports beliefs into futon1
  + BECAUSE: A working bridge proves ants can reason over the same facts as the rest of the stack

  + EVIDENCE:
    evidence[futon1 graph-memory API documented and operational]
    evidence[FUTON2 pivot streams provide raw material for export]

  + NEXT-STEPS:
    next[Design percept‚Üíentity mapping]
    next[Design graph cue‚Üíprior injection]
    next[Version adapter ABI]
    next[Demo: replay colony while futon1 ingests stream]

  :success-criteria
    pass[Adapter bidirectionally converts percepts and graph facts]
    pass[Colony beliefs visible in futon1 salience tables]
    pass[ABI versioned for evolution]
    fail[Export corrupts futon1 state]

  :psr-example "Selected graph adapter for futon1 integration because shared facts enable cross-futon reasoning"
  :pur-template "Adapter export {{colony}}, entities: {{count}}, relations: {{rels}}"


! instantiated-by: Prototype 10 ‚Äî futon3 Proofwork Bridge [üåÄ/ÂÜÖ üôÖ/Âàä]
  :maturity :greenfield
  :depends-on [f2/P6, f2/P7]
  :source [f3/trails f3/MUSN]
  :evidence-for-active [Trail‚Üímission translator working; agent runs logged as trail payloads]

  + context: FUTON3 trails record which patterns were checked during human work sessions.
  + IF: FUTON2 analyzers should ingest trails and commission agent goals
  + HOWEVER: No ingestion path for trail EDN, no feedback loop to direct agents
  + THEN: Add trail‚Üímission translator, plus reporting showing how agent runs affect subsequent checks
  + BECAUSE: Shared missions keep the energy loop tight between simulations and human proofwork

  + EVIDENCE:
    evidence[FUTON3 trails operational with pattern tracking]
    evidence[FUTON2 can emit mission-style payloads via pivot]

  + NEXT-STEPS:
    next[Design trail‚Üímission schema]
    next[Implement trail ingestion in FUTON2]
    next[Add mission‚Üíagent goal queue]
    next[Report agent impact on pattern checks]

  :success-criteria
    pass[Trails ingestible as agent missions]
    pass[Agent runs produce trail-style payloads]
    pass[Feedback loop visible in reports]
    fail[Trails and agent runs disconnected]

  :psr-example "Selected proofwork bridge for shared energy because human and agent work should reinforce"
  :pur-template "Trail ingested {{trail}}, missions: {{count}}, agent runs: {{runs}}"


! instantiated-by: Prototype 11 ‚Äî Curriculum & Behaviour Cards [üé¥/‰π° üêú/‰∫à]
  :maturity :greenfield
  :depends-on [f2/P7]
  :evidence-for-active [Named curriculum with fixed-seed episodes; behaviour cards exportable]

  + context: The current war scenario is rich but single-purpose.
  + IF: FUTON2 should double as a pedagogical engine for Active Inference
  + HOWEVER: There is no named curriculum
  + THEN: Create behaviour cards (home-return, starvation spiral, over-exploration, defensive lattice, greedy gatherer), simulate with fixed seeds, export episodes
  + BECAUSE: These cards seed pattern extraction and future training systems

  + EVIDENCE:
    evidence[Fixed-seed simulation possible]
    evidence[Various behavioral modes observable in runs]

  + NEXT-STEPS:
    next[Define 5 canonical behaviour cards with descriptions]
    next[Record fixed-seed episodes for each]
    next[Export episodes as training data]
    next[Document as AIF pedagogy resource]

  :success-criteria
    pass[Each behaviour card has fixed-seed episode]
    pass[Episodes exportable for training]
    pass[Cards serve as AIF teaching examples]
    fail[Behaviours not reproducible across runs]

  :psr-example "Selected curriculum cards for AIF pedagogy because worked examples accelerate learning"
  :pur-template "Behaviour card {{name}}, seed: {{seed}}, steps: {{steps}}"


! instantiated-by: Prototype 12 ‚Äî Viriya Metrics [‚ö°Ô∏è/‰π† üêú/Â∑±]
  :maturity :greenfield
  :depends-on [f2/P6, f2/P9, f2/P10]
  :evidence-for-active [Viriya indicators logged per episode; futon3/futon7 can read energy health]

  + context: FUTON2 carries the Factor of Awakening "energy/viriya": vigor, commitment, kinetic practice.
  + IF: Simulations should reflect and inform real social activation
  + HOWEVER: Current metrics stop at hunger/tau; nothing measures vigor or coordination throughput
  + THEN: Introduce viriya indicators (colony activation score, pledge adherence, trail transfer), log per episode, export to futon3/futon7
  + BECAUSE: Tying simulation to viriya turns FUTON2 into a practice accelerator

  + EVIDENCE:
    evidence[Hunger/tau metrics operational]
    evidence[Colony-level aggregates computable from pivot]

  + NEXT-STEPS:
    next[Define viriya indicator formulas]
    next[Implement colony activation score]
    next[Export viriya metrics to futon3/futon7]
    next[Document practice acceleration use cases]

  :success-criteria
    pass[Viriya indicators computed per episode]
    pass[Higher futons can read energy health]
    pass[Metrics correlate with observable colony vigor]
    fail[Viriya disconnected from actual dynamics]

  :psr-example "Selected viriya metrics for practice integration because simulation should inform real activation"
  :pur-template "Episode {{id}}, viriya score: {{score}}, activation: {{level}}"


! instantiated-by: Prototype 13 ‚Äî Debugger & Visualiser [üòª/Áî± üö¢/‰∏Ä]
  :maturity :greenfield
  :depends-on [f2/P6]
  :evidence-for-active [Clerk notebook plots tau/hunger/error timelines; follow-agent mode traces mu]

  + context: Pivot logs are textual and require manual parsing.
  + IF: You want interactive introspection of mu vectors, tau evolution, and weighted errors
  + HOWEVER: No visualiser or "follow Alice" mode exists
  + THEN: Build Clerk notebook plotting tau, hunger, errors, pivot timelines; add mode that traces one agent's full mu timeline
  + BECAUSE: Visual insight accelerates iteration and debugging

  + EVIDENCE:
    evidence[Pivot data available for visualization]
    evidence[trace_tick.clj generates SVG plots]

  + NEXT-STEPS:
    next[Build Clerk notebook for AIF visualization]
    next[Add follow-agent mode for single-ant tracing]
    next[Plot mu vector evolution over time]
    next[Integrate with pivot stream for live updates]

  :success-criteria
    pass[Tau/hunger/error plottable interactively]
    pass[Single agent traceable through full episode]
    pass[Visualizations update from pivot stream]
    fail[Debugging requires manual log parsing]

  :psr-example "Selected debugger for development velocity because visual insight beats log parsing"
  :pur-template "Debug session {{id}}, agent: {{agent}}, frames: {{count}}"
