#!/usr/bin/env bash
set -euo pipefail

topic="${1:-tools}"
session_id="${FUTON3_MUSN_SESSION_ID:-}"
if [[ -n "$session_id" ]]; then
  touch "/tmp/futon3-musn-help-${session_id}.flag"
else
  touch "/tmp/futon3-musn-help.flag"
fi

cat <<'EOF'
[MUSN-HELP]
You start with 100 mana points. Gain mana by reading patterns and completing their next steps.
Most other actions cost mana.
Helper functions live in /home/joe/code/futon3/scripts â€” use those exact paths.
Related design patterns live in /home/joe/code/futon3/library; you may read/edit them if helpful.
Tool roster (you should emit these signals when you do the corresponding action):
- /home/joe/code/futon3/scripts/pattern-select library/<pattern> <state why you want to read it>
- /home/joe/code/futon3/scripts/pattern-use    library/<pattern> <state where you will apply it>
- /home/joe/code/futon3/scripts/pattern-action read|update|implement library/<pattern> <note>
- /home/joe/code/futon3/scripts/musn-chat      "question for the user" (human-contact, costs 5 mana)
- /home/joe/code/futon3/scripts/musn-plan      "Plan: ..."
- /home/joe/code/futon3/scripts/wide-search   <rg args>
- /home/joe/code/futon3/scripts/musn-hud      Use this command to bring up helpful pattern guidance and stats about your run.
- /home/joe/code/futon3/scripts/musn-help     Brings up this help screen.
- /home/joe/code/futon3/scripts/give-mana    Donate mana to the pool (pure dana). Use for sospeso protocol.
Further information can be obtained by running musn-help <tool> or musn-help <pattern>
Before using a tool, state a 1-2 line plan.
Your next output should exercise musn-plan by describing your next steps.
[/MUSN-HELP]
EOF

case "$topic" in
  tools|tool|/tools|/help)
    ;;
  pattern|patterns|/pattern)
    cat <<'EOF'

MUSN help: pattern selection
- Select a pattern before implement/update.
- Pattern ids look like namespace/name (example: f2/p13).
- In multiarg files, use the @arg pattern id (not the file basename).
EOF
    ;;
  musn|/musn)
    cat <<'EOF'

MUSN help: core patterns (one line each)
- musn/plan-before-tool: require a plan line before any tool or wide scan.
- musn/declare-scope: state in-bounds, out-of-bounds, and exit condition up front.
- musn/intent-restatement: first line must be "hud-intent: <brief restatement>".
- musn/read-aif-plus-one: read the AIF suggestion plus one other candidate before acting.
- musn/off-trail-brief-log: keep off-trail notes brief and record why.
- musn/psr-pur-real-actions: PSR/PUR should reflect real actions with evidence.
- musn/pattern-action-rpc: log pattern actions via pattern-action RPC.
- musn/pattern-action-justification: justify implement/update notes with why the edit fits.
- musn/pattern-action-helper-command: use scripts/pattern-action for pattern logging.
- musn/tool-name-hygiene: do not guess tool names; use documented helpers.
- musn/fulab-report-block: end responses with a FULAB-REPORT block.

Scope guardrail (local): avoid repo-wide rg/rg --files scans; announce or ask first.
EOF
    ;;
  *)
    echo "usage: musn-help [tools|pattern|musn]" >&2
    exit 2
    ;;
esac
