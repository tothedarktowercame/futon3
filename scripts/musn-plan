#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
usage:
  musn-plan --diagram-file <path>
  musn-plan --diagram <edn>
  musn-plan --diagram-stdin

Plan diagram requirements (EDN):
  - Must be a wiring diagram with :nodes, :edges, :output
  - Use these components for steps:
      :musn.plan/action-reasoning  ;; reasoning note
      :musn.plan/action-command    ;; shell command
      :musn.plan/action-file-edit  ;; file edits/patches
      :musn.plan/action-tool       ;; external tool/API use
  - Typical flow is a :musn.plan/sequence node with edges from each step.

Example (maps reasoning/command/file-edit/tool to components):
  {:nodes [{:id :s1 :component :musn.plan/action-reasoning
            :params {:note "Define plan object schema"}}
           {:id :s2 :component :musn.plan/action-command
            :params {:cmd "rg -n \"plan\" src"}}
           {:id :s3 :component :musn.plan/action-file-edit
            :params {:note "Update registry schema file"}}
           {:id :s4 :component :musn.plan/action-tool
            :params {:note "Query external API for reference"}}
           {:id :seq :component :musn.plan/sequence}]
   :edges [{:from :s1 :to :seq :to-port :actions}
           {:from :s2 :to :seq :to-port :actions}
           {:from :s3 :to :seq :to-port :actions}
           {:from :s4 :to :seq :to-port :actions}]
   :output :seq}
EOF
}

if [[ $# -lt 1 ]]; then
  usage >&2
  exit 2
fi
sid="${FUTON3_MUSN_SESSION_ID:-}"
url="${FUTON3_MUSN_URL:-http://localhost:6065}"

if [[ -z "$sid" ]]; then
  echo "musn-plan: missing FUTON3_MUSN_SESSION_ID" >&2
  exit 2
fi

mode=""
payload=""
if [[ "${1-}" == "--diagram-file" ]]; then
  mode="file"
  payload="${2-}"
  shift 2
elif [[ "${1-}" == "--diagram" ]]; then
  mode="inline"
  shift
  payload="$*"
elif [[ "${1-}" == "--diagram-stdin" ]]; then
  mode="stdin"
  shift
else
  usage >&2
  exit 2
fi

SID="$sid" URL="$url" MODE="$mode" PAYLOAD="$payload" clojure -M -e '
  (require '\''[clojure.edn :as edn])
  (require '\''[clj-http.client :as http])
  (require '\''[cheshire.core :as json])
  (def sid (System/getenv "SID"))
  (def url (or (System/getenv "URL") ""))
  (def helper (some-> (System/getenv "FUTON3_MUSN_HELPER_MODE") clojure.string/lower-case))
  (def mode (or (System/getenv "MODE") ""))
  (def payload (System/getenv "PAYLOAD"))
  (defn post! [path body]
    (let [resp (http/post (str url path)
                          {:content-type :json
                           :accept :json
                           :throw-exceptions false
                           :body (json/generate-string body)})]
      (when (= 200 (:status resp))
        (json/parse-string (:body resp) true))))
  (try
    (if (= helper "stream")
      (do (println (json/generate-string {:ok true})) (System/exit 0))
      (let [diagram (case mode
                      "file" (edn/read-string (slurp payload))
                      "inline" (edn/read-string payload)
                      "stdin" (edn/read-string (slurp *in*))
                      (throw (ex-info "unknown mode" {:mode mode})))
            state (post! "/musn/session/state" {:session/id sid})
            turn (get-in state [:state :turn])]
        (when-not turn
          (throw (ex-info "missing turn in session state" {:state state})))
        (post! "/musn/turn/plan" {:session/id sid
                                 :turn (int turn)
                                 :plan/diagram diagram})
        (println (json/generate-string {:ok true :turn (int turn)}))))
    (catch Throwable t
      (println (json/generate-string {:ok false :error (.getMessage t)}))
      (System/exit 0)))
'
