#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
room="${FUTON3_MUSN_CHAT_ROOM:-lab}"
author="${FUTON3_MUSN_CHAT_AUTHOR:-fucodex}"
intent="Join the chat and ask a clarifying question."
prompt="Join the chat and ask the user what they want to focus on."
musn_url="${FUTON3_MUSN_URL:-http://localhost:6065}"
background=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --room)
      room="$2"; shift 2;;
    --author)
      author="$2"; shift 2;;
    --intent)
      intent="$2"; shift 2;;
    --prompt)
      prompt="$2"; shift 2;;
    --musn-url)
      musn_url="$2"; shift 2;;
    --background)
      background=true; shift;;
    --help|-h)
      echo "usage: musn-chat-summon [--room ROOM] [--author NAME] [--intent TEXT] [--prompt TEXT] [--musn-url URL] [--background]" >&2
      exit 0;;
    *)
      break;;
  esac
done

cmd=("$ROOT/fucodex"
     --live
     --musn
     --musn-url "$musn_url"
     --chat-room "$room"
     --chat-author "$author"
     --intent "$intent"
     exec
     --prompt "$prompt")

export FUTON3_MUSN_REQUIRE_APPROVAL=0
export FUTON3_MUSN_CHAT_TRIM=1

if $background; then
  nohup "${cmd[@]}" >/tmp/musn-chat-summon.log 2>&1 &
  echo $!
else
  exec "${cmd[@]}"
fi
