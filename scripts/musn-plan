#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "usage: musn-plan [--diagram --step \"type: detail\" ...] <plan line>" >&2
  exit 2
fi
sid="${FUTON3_MUSN_SESSION_ID:-}"
url="${FUTON3_MUSN_URL:-http://localhost:6065}"

if [[ -z "$sid" ]]; then
  echo "musn-plan: missing FUTON3_MUSN_SESSION_ID" >&2
  exit 2
fi

SID="$sid" URL="$url" python3 - "$@" <<'PY'
import json
import os
import sys
import urllib.request
import re

sid = os.environ.get("SID", "")
url = os.environ.get("URL", "").rstrip("/")
helper_mode = os.environ.get("FUTON3_MUSN_HELPER_MODE", "").lower()
args = list(sys.argv[1:])

def post(path, payload):
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(url + path, data=data, method="POST")
    req.add_header("Content-Type", "application/json")
    with urllib.request.urlopen(req, timeout=2) as resp:
        raw = resp.read().decode("utf-8") or "{}"
        return json.loads(raw)

def usage():
    return (
        "usage: musn-plan [--diagram --step \"type: detail\" ...] <plan line>\n"
        "  types: reasoning|command|file-edit|tool (default: reasoning)\n"
    )

def parse_args(argv):
    steps = []
    diagram_mode = False
    plan_line = []
    i = 0
    while i < len(argv):
        token = argv[i]
        if token in ("-h", "--help"):
            print(usage())
            raise SystemExit(0)
        if token == "--diagram":
            diagram_mode = True
            i += 1
            continue
        if token == "--step":
            if i + 1 >= len(argv):
                raise RuntimeError("--step requires a value")
            steps.append(argv[i + 1])
            i += 2
            continue
        plan_line.append(token)
        i += 1
    return diagram_mode, steps, " ".join(plan_line).strip()

def step_to_node(step, idx):
    raw = (step or "").strip()
    m = re.match(r"(?i)^(reasoning|reason|think|note|command|cmd|file-edit|edit|tool)\s*:\s*(.*)$", raw)
    if m:
        kind = m.group(1).lower()
        body = m.group(2).strip()
    else:
        kind = "reasoning"
        body = raw
    if kind in ("command", "cmd"):
        component = "musn.plan/action-command"
        params = {"cmd": body}
    elif kind in ("file-edit", "edit"):
        component = "musn.plan/action-file-edit"
        params = {"note": body}
    elif kind == "tool":
        component = "musn.plan/action-tool"
        params = {"note": body}
    else:
        component = "musn.plan/action-reasoning"
        params = {"note": body}
    return {"id": f"s{idx}", "component": component, "params": params}

try:
    if helper_mode == "stream":
        print(json.dumps({"ok": True}))
        raise SystemExit(0)
    diagram_mode, steps, plan_line = parse_args(args)
    state = post("/musn/session/state", {"session/id": sid})
    turn = (state.get("state") or {}).get("turn")
    if not turn:
        raise RuntimeError("missing turn in session state")

    if steps or diagram_mode:
        if not steps:
            raise RuntimeError("diagram mode requires at least one --step")
        nodes = [step_to_node(step, i + 1) for i, step in enumerate(steps)]
        nodes.append({"id": "seq", "component": "musn.plan/sequence"})
        edges = [{"from": node["id"], "to": "seq", "to-port": "actions"} for node in nodes if node["id"] != "seq"]
        diagram = {"nodes": nodes, "edges": edges, "output": "seq"}
        post("/musn/turn/plan", {"session/id": sid, "turn": int(turn), "plan/diagram": diagram})
    else:
        if not plan_line:
            raise RuntimeError("missing plan line")
        post("/musn/turn/plan", {"session/id": sid, "turn": int(turn), "plan": plan_line})

    print(json.dumps({"ok": True, "turn": int(turn)}))
except Exception as exc:
    print(json.dumps({"ok": False, "error": str(exc)}))
    sys.exit(0)
PY
