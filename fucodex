#!/usr/bin/env bash
set -euo pipefail

if [[ -z "${BASH_VERSION-}" ]]; then
  exec bash "$0" "$@"
fi

# Debug: print invoked command and env when troubleshooting MUSN classpath
if [[ "${FUCODEX_DEBUG-}" == "1" ]]; then
  set -x
fi

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Extra deps/paths layered on top of the project basis when running lab/musn streams.
LAB_DEPS='{:paths ["scripts" "src" "resources" "dev" "."] :deps {org.clojure/data.json {:mvn/version "2.5.0"} cheshire/cheshire {:mvn/version "5.11.0"} clj-http/clj-http {:mvn/version "3.12.3"} futon2/futon2 {:local/root "/home/joe/code/futon2"}}}'
START_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
RUN_CWD="$(pwd)"
export PATH="$ROOT/scripts:$PATH"

LIVE=false
PATTERNS=""
CHOSEN=""
CLOCK_IN=""
FORCED_SESSION_ID=""
AIF_CONFIG=""
AIF_EXPLAIN=false
AIF_EXPLAIN_PATH=""
AIF_SELECT=false
PROPOSAL_HOOK=false
EXPLORE=false
EXPLORE_CATALOG=""
EXPLORE_HOTWORDS=""
EXPLORE_NAMESPACES=""
EXPLORE_LIMIT="4"
EXPLORE_PROMPT_FILE="docs/codex-exploratory-mission.md"
HUD_MODE=true
HUD_INTENT=""
RAW_PROMPT=""
APPROVAL_POLICY=""
SKIP_GIT_CHECK=false
HUD_PRINT=false
HUD_SERVER="${HUD_SERVER:-http://localhost:5050}"
FUTON3_CODEX_SERVER_URL="${FUTON3_CODEX_SERVER_URL:-http://localhost:6060}"
export FUTON3_CODEX_SERVER_URL
PATTERN_RPC=true
PAUSE_ON_NO_WRITE="${FUCODEX_PAUSE_ON_NO_WRITE:-auto}"
MUSN_MODE=false
MUSN_URL="${FUCODEX_MUSN_URL:-http://localhost:6065}"
UNSANDBOXED=false
CHAT_ROOM="${FUCODEX_CHAT_ROOM:-}"
CHAT_AUTHOR="${FUCODEX_CHAT_AUTHOR:-}"
SCOPE_GUARDRAIL=$'Scope guardrail: avoid repo-wide `rg --files` or wide `rg` searches.\nBefore tool use, state a 1-2 line plan; if a wide scan is likely, either (a) announce it and proceed, or (b) stop and ask for scope; if asking, do not run the scan.\nTreat wide scans as expensive.'
INTENT_PREFACE=$'First output line format: hud-intent: <one-sentence summary of the text below>.\nDo not call tools or run commands before emitting that line.\nSummarize ONLY the text between <INTENT_TEXT> and </INTENT_TEXT>. Do not include quotes, placeholders, or planning.\n<INTENT_TEXT>\n'
INTENT_POSTFACE=$'\n</INTENT_TEXT>\nAfter that line, continue with the task using the instructions that follow. Do not summarize any other instructions below.'
MANA_START="${FUTON3_MUSN_MANA_START:-100}"
MANA_BALANCE="${FUTON3_MUSN_MANA_BALANCE:-$MANA_START}"
MANA_EARNED="${FUTON3_MUSN_MANA_EARNED:-0}"
MANA_SPENT="${FUTON3_MUSN_MANA_SPENT:-0}"
MUSN_HELP="${FUCODEX_MUSN_HELP:-auto}"
MUSN_SESSION_ID="${FUTON3_MUSN_SESSION_ID:-}"
MUSN_HELP_FORCE=false
MUSN_HUD_FORCE=false

if [[ "${FUCODEX_HUD-}" == "0" || "${FUCODEX_HUD-}" == "false" ]]; then
  HUD_MODE=false
fi
if [[ "${FUCODEX_UNSANDBOXED-}" == "1" || "${FUCODEX_UNSANDBOXED-}" == "true" ]]; then
  UNSANDBOXED=true
fi

show_help() {
  cat <<'EOF'
Usage: fucodex [--live] [--patterns CSV] [--chosen PATTERN] [--clock-in PATTERN] [--session-id ID] [--aif-config PATH] [--aif-explain [PATH]]... [args...]

Options:
  -h, --help           Show this help.
  --live               Run Codex in live mode with lab streaming.
  --patterns CSV       Comma-separated patterns for the run manifest.
  --chosen PATTERN     Set chosen pattern (ignored when --clock-in is provided).
  --clock-in PATTERN   Add a clock-in pattern (repeatable or comma-separated; overrides --chosen).
  --session-id ID      Force a session id for stream/export/summary (skips selection).
  --aif-config PATH    EDN config file to tune AIF scoring parameters.
  --aif-explain [PATH] Explain AIF config with a worked example and exit.
  explore              Run the exploratory mission prompt (manual heuristic).
  --explore-catalog     Pattern catalog path (default: resources/sigils/patterns-index.tsv)
  --explore-hotwords    CSV list of hotwords to bias candidate selection.
  --explore-namespaces  CSV list of namespaces to consider.
  --explore-limit       Max candidates to select (default: 4).
  --explore-prompt      Prompt file to use (default: docs/codex-exploratory-mission.md).
  --aif-select          Let AIF choose the pattern (used in explore).
  --proposal-hook       Emit proposal draft when candidates are insufficient.
  --hud                 Enable HUD mode: seed patterns into prompt, parse response (default on).
  --no-hud              Disable HUD mode even if default is on.
  --intent TEXT         Intent/goal for HUD pattern selection.
  --approval-policy     Approval policy for codex exec (e.g., untrusted, never).
  --no-sandbox          Run codex exec with no sandbox or approvals (dangerous).
  --pattern-rpc         Enable pattern-action RPC and enforce explicit reads (default: on).
  --pause-on-no-write   Pause live runs when selection mode=use but no files change.
  --no-pause-on-no-write Disable pause-on-no-write (overrides env default).
  --musn                Route through MUSN mode (enable MUSN preflight and exports).
  --musn-url URL        MUSN service base URL (default: http://localhost:6065 or $FUCODEX_MUSN_URL).
  --chat-room ROOM      Post agent messages into MUSN chat room (enables --musn).
  --chat-author NAME    Display name for chat messages (defaults to client id).
  --hud-print           Print HUD block before running codex.
  --hud-server URL      HUD server base URL (default: http://localhost:5050).

Examples:
  fucodex --live exec --prompt "Draft the summary"
  fucodex --live --patterns "ants/white-space-scout" --chosen ants/white-space-scout exec --prompt "Explain"
  fucodex --live --clock-in ants/white-space-scout --clock-in ants/pheromone-trail-tuner exec --prompt "Review"
  fucodex --live resume --last "Continue work"
  fucodex --aif-explain docs/aif/fulab-config.edn
  fucodex --aif-explain
  fucodex explore --explore-hotwords "aif,session,trace"
  fucodex exec --prompt "Non-live run"
  fucodex --hud --intent "implement schema" exec --prompt "Add belief-state schema"
EOF
}

args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0;;
    --live)
      LIVE=true; shift;;
    --patterns)
      PATTERNS="$2"; shift 2;;
    --chosen)
      CHOSEN="$2"; shift 2;;
    --clock-in)
      if [[ -n "$CLOCK_IN" ]]; then
        CLOCK_IN="${CLOCK_IN},$2"
      else
        CLOCK_IN="$2"
      fi
      shift 2;;
    --session-id)
      FORCED_SESSION_ID="$2"; shift 2;;
    --aif-config)
      AIF_CONFIG="$2"; shift 2;;
    --aif-explain)
      AIF_EXPLAIN=true
      if [[ -n "${2-}" && "${2-}" != --* ]]; then
        AIF_EXPLAIN_PATH="$2"
        shift 2
      else
        shift
      fi;;
    explore)
      EXPLORE=true; shift;;
    --explore-catalog)
      EXPLORE_CATALOG="$2"; shift 2;;
    --explore-hotwords)
      EXPLORE_HOTWORDS="$2"; shift 2;;
    --explore-namespaces)
      EXPLORE_NAMESPACES="$2"; shift 2;;
    --explore-limit)
      EXPLORE_LIMIT="$2"; shift 2;;
    --explore-prompt)
      EXPLORE_PROMPT_FILE="$2"; shift 2;;
    --aif-select)
      AIF_SELECT=true; shift;;
    --proposal-hook)
      PROPOSAL_HOOK=true; shift;;
    --hud)
      HUD_MODE=true; shift;;
    --no-hud)
      HUD_MODE=false; shift;;
    --intent)
      HUD_INTENT="$2"; shift 2;;
    --approval-policy)
      APPROVAL_POLICY="$2"; shift 2;;
    --no-sandbox|--unsandboxed)
      UNSANDBOXED=true; shift;;
    --pattern-rpc)
      PATTERN_RPC=true; shift;;
    --pause-on-no-write)
      PAUSE_ON_NO_WRITE="true"; shift;;
    --no-pause-on-no-write)
      PAUSE_ON_NO_WRITE="false"; shift;;
    --musn)
      MUSN_MODE=true; shift;;
    --musn-url)
      MUSN_MODE=true
      MUSN_URL="$2"; shift 2;;
    --chat-room)
      MUSN_MODE=true
      CHAT_ROOM="$2"; shift 2;;
    --chat-author)
      CHAT_AUTHOR="$2"; shift 2;;
    --hud-print)
      HUD_PRINT=true; shift;;
    --hud-server)
      HUD_SERVER="$2"; shift 2;;
    *)
      args+=("$1"); shift;;
  esac
done

if [[ "${CODEX_SKIP_GIT_REPO_CHECK-}" == "1" || "${CODEX_SKIP_GIT_REPO_CHECK-}" == "true" ]]; then
  SKIP_GIT_CHECK=true
fi

if $AIF_EXPLAIN; then
  explain_path="$AIF_EXPLAIN_PATH"
  if [[ -z "$explain_path" && -n "$AIF_CONFIG" ]]; then
    explain_path="$AIF_CONFIG"
  fi
  if [[ -n "$explain_path" ]]; then
    clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-aif-explain.clj" --config "$explain_path"
  else
    clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-aif-explain.clj"
  fi
  exit 0
fi

if $EXPLORE; then
  LIVE=true
  AIF_SELECT=true
  PROPOSAL_HOOK=true
  if [[ -z "$EXPLORE_CATALOG" ]]; then
    EXPLORE_CATALOG="resources/sigils/patterns-index.tsv"
  fi
  if [[ -z "$EXPLORE_NAMESPACES" ]]; then
    EXPLORE_NAMESPACES="ants,code-coherence,stack-coherence,devmap-coherence,contributing"
  fi
  if [[ -z "$PATTERNS" || -z "$CHOSEN" ]]; then
    read -r explore_chosen explore_candidates < <(clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-explore-candidates.clj" \
      --catalog "$EXPLORE_CATALOG" \
      --limit "$EXPLORE_LIMIT" \
      ${EXPLORE_HOTWORDS:+--hotwords "$EXPLORE_HOTWORDS"} \
      ${EXPLORE_NAMESPACES:+--namespaces "$EXPLORE_NAMESPACES"})
    if [[ -z "$PATTERNS" ]]; then
      PATTERNS="$explore_candidates"
    fi
    if [[ -z "$CHOSEN" && "$AIF_SELECT" != true ]]; then
      CHOSEN="$explore_chosen"
    fi
  fi
  if [[ ${#args[@]} -eq 0 ]]; then
    if [[ ! -f "$ROOT/$EXPLORE_PROMPT_FILE" ]]; then
      echo "[lab] explore prompt file not found: $EXPLORE_PROMPT_FILE" >&2
      exit 2
    fi
    prompt=$(awk 'BEGIN{inside=0} /^```/{if(inside){exit} else {inside=1; next}} inside{print}' "$ROOT/$EXPLORE_PROMPT_FILE")
    if [[ -z "$prompt" ]]; then
      echo "[lab] explore prompt missing fenced block in $EXPLORE_PROMPT_FILE" >&2
      exit 2
    fi
    args=("$prompt")
  fi
fi

if [[ -n "$CHOSEN" && -n "$CLOCK_IN" ]]; then
  echo "[lab] warning: --chosen is ignored when --clock-in is provided" >&2
fi

if $PATTERN_RPC && [[ -z "$FORCED_SESSION_ID" ]]; then
  FORCED_SESSION_ID="$(python3 - <<'PY'
import uuid
print(f"codex-{uuid.uuid4().hex[:8]}")
PY
)"
fi

if [[ -z "$APPROVAL_POLICY" && "$PATTERN_RPC" == true ]]; then
  APPROVAL_POLICY="untrusted"
fi

if [[ "$PAUSE_ON_NO_WRITE" == "auto" ]]; then
  if $LIVE && $PATTERN_RPC; then
    PAUSE_ON_NO_WRITE="true"
  else
    PAUSE_ON_NO_WRITE="false"
  fi
fi

if $MUSN_MODE && [[ -z "$MUSN_SESSION_ID" ]]; then
  if [[ -n "$FORCED_SESSION_ID" ]]; then
    MUSN_SESSION_ID="$FORCED_SESSION_ID"
  else
    MUSN_SESSION_ID="musn-$(python3 - <<'PY'
import uuid
print(str(uuid.uuid4())[:8])
PY
)"
  fi
fi

# Capture the user prompt before any HUD injection.
USER_PROMPT=""
if [[ ${#args[@]} -gt 0 ]]; then
  for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[$i]}" == "--prompt" && $((i+1)) -lt ${#args[@]} ]]; then
      USER_PROMPT="${args[$((i+1))]}"
      break
    fi
  done
  if [[ -z "$USER_PROMPT" && ${#args[@]} -eq 1 && "${args[0]}" != --* ]]; then
    USER_PROMPT="${args[0]}"
  fi
fi

# Prefer the MUSN intent when HUD intent is not explicitly provided.
if [[ -z "${HUD_INTENT-}" && -n "${FUTON3_MUSN_INTENT-}" ]]; then
  HUD_INTENT="$FUTON3_MUSN_INTENT"
fi
if [[ -z "${HUD_INTENT-}" && -n "${USER_PROMPT-}" ]]; then
  HUD_INTENT="$(USER_PROMPT="$USER_PROMPT" python3 - <<'PY'
import os
import re
prompt = os.environ.get("USER_PROMPT", "")
if not prompt:
    raise SystemExit(0)
line = prompt.splitlines()[0] if "\n" in prompt else prompt
line = re.sub(r"[`*_]+", "", line)
line = re.sub(r"\\s+", " ", line).strip()
line = re.sub(r"^\\s*(please|pls)\\s+", "", line, flags=re.IGNORECASE)
for sep in ["â€”", " -- ", " - ", ". ", "? ", "! "]:
    if sep in line:
        line = line.split(sep, 1)[0].strip()
        break
line = line.replace("/home/joe/code/futon3/", "")
line = line.replace("/home/joe/code/", "")
print(line)
PY
)"
fi

# HUD mode: inject pattern context into prompt
HUD_FILE=""
HUD_JSON_FILE=""
if $HUD_MODE; then
  HUD_ENDPOINT="${HUD_SERVER%/}/fulab/hud/format"
  HUD_PAYLOAD=$(HUD_INTENT="$HUD_INTENT" PATTERNS="$PATTERNS" EXPLORE_LIMIT="$EXPLORE_LIMIT" RUN_CWD="$RUN_CWD" \
    MANA_START="$MANA_START" MANA_BALANCE="$MANA_BALANCE" MANA_EARNED="$MANA_EARNED" MANA_SPENT="$MANA_SPENT" \
    MUSN_MODE="$MUSN_MODE" MUSN_HELP="$MUSN_HELP" SESSION_ID="$MUSN_SESSION_ID" \
    python3 - <<'PY'
import json, os

intent = os.environ.get("HUD_INTENT", "")
patterns = os.environ.get("PATTERNS", "")
session_id = (os.environ.get("SESSION_ID", "") or "").strip()
limit = os.environ.get("EXPLORE_LIMIT", "4")
try:
    limit = int(limit)
except ValueError:
    limit = 4
def parse_num(value, default):
    try:
        return float(value)
    except Exception:
        return default
def parse_bool(value, default=False):
    if value is None:
        return default
    raw = str(value).strip().lower()
    if raw in ("1", "true", "yes", "y", "on"):
        return True
    if raw in ("0", "false", "no", "n", "off"):
        return False
    return default

musn_mode = parse_bool(os.environ.get("MUSN_MODE"), False)
raw_help = os.environ.get("MUSN_HELP", "").strip().lower()
if not raw_help or raw_help == "auto":
    musn_help = musn_mode
else:
    musn_help = parse_bool(raw_help, musn_mode)
musn_help_force = parse_bool(os.environ.get("MUSN_HELP_FORCE"), False)
musn_hud_force = parse_bool(os.environ.get("MUSN_HUD_FORCE"), False)

mana_start = parse_num(os.environ.get("MANA_START", "100"), 100.0)
mana_balance = parse_num(os.environ.get("MANA_BALANCE", str(mana_start)), mana_start)
mana_earned = parse_num(os.environ.get("MANA_EARNED", "0"), 0.0)
mana_spent = parse_num(os.environ.get("MANA_SPENT", "0"), 0.0)

prototypes = [p for p in patterns.split(",") if p.strip()] if patterns else []

payload = {
    "intent": intent,
    "prototypes": prototypes,
    "pattern-limit": limit,
    "certify-commit": True,
    "repo-root": os.environ.get("RUN_CWD", os.getcwd()),
}
if session_id:
    payload["session-id"] = session_id
if musn_mode:
    payload["mana"] = {
        "budget": mana_start,
        "balance": mana_balance,
        "earned": mana_earned,
        "spent": mana_spent,
    }
    if musn_help_force:
        payload["musn-help"] = True
        payload["musn-help-force"] = True
    else:
        payload["musn-help"] = musn_help
    if musn_hud_force:
        payload["musn-hud"] = True
        payload["musn-hud-force"] = True

print(json.dumps(payload))
PY
)

  HUD_RESPONSE=$(curl -sS -X POST "$HUD_ENDPOINT" \
    -H "content-type: application/json" \
    -d "$HUD_PAYLOAD") || {
    echo "[fucodex] HUD server not reachable at $HUD_ENDPOINT" >&2
    exit 2
  }
  HUD_JSON_FILE="$(mktemp -t fucodex-hud-XXXXXX.json)"
  trap '[[ -n "${HUD_JSON_FILE-}" ]] && rm -f "$HUD_JSON_FILE"' EXIT
  printf "%s" "$HUD_RESPONSE" > "$HUD_JSON_FILE"
  export FUTON3_HUD_JSON="$HUD_JSON_FILE"

  if [[ -z "$PATTERNS" ]]; then
    HUD_PATTERNS=$(HUD_RESPONSE="$HUD_RESPONSE" python3 - <<'PY'
import json, os

raw = os.environ.get("HUD_RESPONSE", "")
try:
    data = json.loads(raw)
except Exception:
    data = {}

hud = data.get("hud", {}) or {}
candidates = hud.get("candidates", []) or []
ids = [c.get("id") for c in candidates if isinstance(c, dict) and c.get("id")]
print(",".join(ids))
PY
)
    if [[ -n "$HUD_PATTERNS" ]]; then
      PATTERNS="$HUD_PATTERNS"
    fi
  fi

  HUD_BLOCK=$(HUD_RESPONSE="$HUD_RESPONSE" python3 - <<'PY'
import json, os, sys

raw = os.environ.get("HUD_RESPONSE", "")
if not raw:
    sys.exit(1)
try:
    data = json.loads(raw)
except Exception:
    sys.exit(1)
if not data.get("ok"):
    sys.exit(2)
prompt = data.get("prompt", "")
if prompt:
    sys.stdout.write(prompt)
PY
)

  if [[ -z "$HUD_BLOCK" ]]; then
    echo "[fucodex] HUD server returned no prompt" >&2
    exit 2
  fi

  if $HUD_PRINT; then
    echo "$HUD_BLOCK"
  fi
  # Rebuild args with HUD prepended to prompt
  # For codex, the prompt is typically the last arg or after --prompt
  new_args=()
  for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[$i]}" == "--prompt" && $((i+1)) -lt ${#args[@]} ]]; then
      original_prompt="${args[$((i+1))]}"
      combined_prompt="${INTENT_PREFACE}${original_prompt}
${INTENT_POSTFACE}

${HUD_BLOCK}

${SCOPE_GUARDRAIL}

User task: ${original_prompt}"
      new_args+=("--prompt" "$combined_prompt")
      ((i++))  # Skip the next element since we handled it
    elif [[ $i -eq $((${#args[@]}-1)) && "${args[$i]}" != --* && "${new_args[*]}" != *"--prompt"* ]]; then
      # Last arg without --prompt flag (bare prompt)
      combined_prompt="${INTENT_PREFACE}${args[$i]}
${INTENT_POSTFACE}

${HUD_BLOCK}

${SCOPE_GUARDRAIL}

User task: ${args[$i]}"
      new_args+=("$combined_prompt")
    else
      new_args+=("${args[$i]}")
    fi
  done
  args=("${new_args[@]}")
  echo "[fucodex] HUD injected with ${HUD_INTENT:-unspecified} intent" >&2
fi

# Ensure MUSN handshake intent line even when HUD is disabled.
if $MUSN_MODE && ! $HUD_MODE; then
  new_args=()
  for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[$i]}" == "--prompt" && $((i+1)) -lt ${#args[@]} ]]; then
      original_prompt="${args[$((i+1))]}"
      combined_prompt="${INTENT_PREFACE}${original_prompt}
${INTENT_POSTFACE}

${SCOPE_GUARDRAIL}

User task: ${original_prompt}"
      new_args+=("--prompt" "$combined_prompt")
      ((i++))
    elif [[ $i -eq $((${#args[@]}-1)) && "${args[$i]}" != --* && "${new_args[*]}" != *"--prompt"* ]]; then
      combined_prompt="${INTENT_PREFACE}${args[$i]}
${INTENT_POSTFACE}

${SCOPE_GUARDRAIL}

User task: ${args[$i]}"
      new_args+=("$combined_prompt")
    else
      new_args+=("${args[$i]}")
    fi
  done
  args=("${new_args[@]}")
fi

# Normalize --prompt usage for codex exec --json (expects bare prompt string).
if [[ ${#args[@]} -gt 0 ]]; then
  prompt_arg=""
  remaining_args=()
  for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[$i]}" == "--prompt" && $((i+1)) -lt ${#args[@]} ]]; then
      prompt_arg="${args[$((i+1))]}"
      ((i++))
    else
      remaining_args+=("${args[$i]}")
    fi
  done
  if [[ -n "$prompt_arg" ]]; then
    if [[ ${#remaining_args[@]} -gt 0 ]]; then
      echo "[lab] warning: --prompt used; ignoring extra args for codex exec" >&2
    fi
    args=("$prompt_arg")
  fi
fi

if [[ ${#args[@]} -eq 1 && "${args[0]}" != --* ]]; then
  RAW_PROMPT="${args[0]}"
fi

if [[ -n "$FORCED_SESSION_ID" ]]; then
  export FUTON3_CODEX_SESSION_ID="$FORCED_SESSION_ID"
fi
if [[ -n "$HUD_SERVER" && -z "${FUTON3_CODEX_SERVER_URL-}" ]]; then
  export FUTON3_CODEX_SERVER_URL="$HUD_SERVER"
fi
if $MUSN_MODE; then
  # Handshake intent for MUSN/HUD; prefer explicit HUD_INTENT, do not fall back to raw prompt.
  if [[ -n "${FUTON3_MUSN_INTENT-}" ]]; then
    export FUTON3_MUSN_INTENT
  elif [[ -n "$HUD_INTENT" ]]; then
    export FUTON3_MUSN_INTENT="$HUD_INTENT"
  fi
  if [[ -n "$RAW_PROMPT" ]]; then
    export FUTON3_MUSN_PROMPT="$RAW_PROMPT"
  fi
fi
if $PATTERN_RPC; then
  export PATTERN_ACTION_RPC=1
fi
if $MUSN_MODE; then
  export FUTON3_MUSN_URL="$MUSN_URL"
  if [[ -n "$MUSN_SESSION_ID" ]]; then
    export FUTON3_MUSN_SESSION_ID="$MUSN_SESSION_ID"
  fi
  export FUTON3_MUSN_HELPER_MODE="stream"
  if [[ -n "$AIF_CONFIG" ]]; then
    export FUTON3_MUSN_AIF_CONFIG_PATH="$AIF_CONFIG"
  fi
  if [[ -n "$CHAT_ROOM" ]]; then
    export FUTON3_MUSN_CHAT_ROOM="$CHAT_ROOM"
  fi
  if [[ -n "$CHAT_AUTHOR" ]]; then
    export FUTON3_MUSN_CHAT_AUTHOR="$CHAT_AUTHOR"
  fi
  if [[ -n "$MUSN_SESSION_ID" && -f "/tmp/futon3-musn-help-${MUSN_SESSION_ID}.flag" ]]; then
    MUSN_HELP_FORCE=true
    rm -f "/tmp/futon3-musn-help-${MUSN_SESSION_ID}.flag"
  elif [[ -f "/tmp/futon3-musn-help.flag" ]]; then
    MUSN_HELP_FORCE=true
    rm -f "/tmp/futon3-musn-help.flag"
  fi
  if [[ -n "$MUSN_SESSION_ID" && -f "/tmp/futon3-musn-hud-${MUSN_SESSION_ID}.flag" ]]; then
    MUSN_HUD_FORCE=true
    rm -f "/tmp/futon3-musn-hud-${MUSN_SESSION_ID}.flag"
  elif [[ -f "/tmp/futon3-musn-hud.flag" ]]; then
    MUSN_HUD_FORCE=true
    rm -f "/tmp/futon3-musn-hud.flag"
  fi
  export MUSN_HELP_FORCE
  export MUSN_HUD_FORCE
fi

if $PATTERN_RPC && [[ ${#args[@]} -eq 1 ]]; then
  if [[ "${args[0]}" != *"Scope guardrail:"* ]]; then
    args=("${SCOPE_GUARDRAIL}

User task: ${args[0]}")
  fi
fi

if $LIVE; then
  if [[ ${#args[@]} -eq 0 ]]; then
    echo "[lab] --live requires a codex command (use 'exec \"...\"' or a subcommand)" >&2
    show_help
    exit 2
  fi
  if $MUSN_MODE; then
    preflight_mode="${FUCODEX_PREFLIGHT:-auto}"
    preflight_mode="$(printf '%s' "$preflight_mode" | tr '[:upper:]' '[:lower:]')"
    if [[ "$preflight_mode" != "off" && "$preflight_mode" != "0" && "$preflight_mode" != "false" ]]; then
      if ! MUSN_URL="$MUSN_URL" clojure -M -m scripts.musn_http_preflight >/dev/null; then
        echo "[lab] MUSN HTTP preflight failed; aborting run" >&2
        exit 2
      fi
    fi
  fi
  if [[ "${args[0]-}" == "exec" ]]; then
    args=("${args[@]:1}")
  fi
  set -o pipefail
  clj_args=(--lab-root "$ROOT/lab")
  if [[ -n "$PATTERNS" ]]; then
    clj_args+=(--patterns "$PATTERNS")
  fi
  if [[ -n "$CHOSEN" ]]; then
    clj_args+=(--chosen "$CHOSEN")
  fi
  if [[ -n "$CLOCK_IN" ]]; then
    clj_args+=(--clock-in "$CLOCK_IN")
  fi
  if [[ -n "$FORCED_SESSION_ID" ]]; then
    clj_args+=(--session-id "$FORCED_SESSION_ID")
  fi
  if [[ -n "$AIF_CONFIG" ]]; then
    clj_args+=(--aif-config "$AIF_CONFIG")
  fi
  if [[ -n "$HUD_JSON_FILE" ]]; then
    clj_args+=(--hud-json "$HUD_JSON_FILE")
  fi
  if [[ ${#args[@]} -gt 0 ]]; then
    prompt_text=$(printf "%s " "${args[@]}")
    trail_allow=$(python3 - <<'PY'
import re
import sys

text = sys.stdin.read().strip().lower()
namespaces = sorted(set(re.findall(r"library/([a-z0-9_-]+)", text)))
if namespaces:
    print(",".join(namespaces))
PY
<<<"$prompt_text")
    if [[ -n "$trail_allow" ]]; then
      clj_args+=(--trail-allow "$trail_allow")
    fi
  fi
  if $AIF_SELECT; then
    clj_args+=(--aif-select)
  fi
  if $PROPOSAL_HOOK; then
    clj_args+=(--proposal-hook)
  fi
  if $PATTERN_RPC; then
    clj_args+=(--enforce-pattern-actions)
  fi
  if [[ "$PAUSE_ON_NO_WRITE" == "true" ]]; then
    clj_args+=(--pause-on-no-write)
  fi
  preflight_mode="${FUCODEX_PREFLIGHT:-auto}"
  preflight_mode="$(printf '%s' "$preflight_mode" | tr '[:upper:]' '[:lower:]')"
  if [[ "$preflight_mode" != "off" && "$preflight_mode" != "0" && "$preflight_mode" != "false" ]]; then
    preflight_stamp="$ROOT/lab/.lab_stream_codex.preflight"
    preflight_needed=true
    if [[ "$preflight_mode" == "auto" ]]; then
      current_hash="$(cksum "$ROOT/dev/lab_stream_codex.clj" | awk '{print $1 "-" $2}')"
      if [[ -f "$preflight_stamp" ]]; then
        read -r cached_hash < "$preflight_stamp"
        if [[ "$cached_hash" == "$current_hash" ]]; then
          preflight_needed=false
        fi
      fi
    fi
    if $preflight_needed; then
      if ! clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab_stream_codex.clj" --help >/dev/null; then
        echo "[lab] preflight failed: dev/lab_stream_codex.clj did not compile; aborting run" >&2
        exit 2
      fi
      if [[ "$preflight_mode" == "auto" && -n "${current_hash-}" ]]; then
        echo "$current_hash" > "$preflight_stamp"
      fi
    fi
  fi
  codex_flags=(--json --skip-git-repo-check)
  if $SKIP_GIT_CHECK; then
    codex_flags+=(--skip-git-repo-check)
  fi
  if [[ -n "$APPROVAL_POLICY" ]]; then
    codex_flags+=(-c "approval_policy=\"$APPROVAL_POLICY\"")
  fi
  if $UNSANDBOXED; then
    codex_flags+=(--dangerously-bypass-approvals-and-sandbox)
  fi
  if [[ ${#args[@]} -gt 0 && "${args[0]}" == -* ]]; then
    codex_flags+=(--)
  fi
  pause_exit=false
  set +e
  if $MUSN_MODE; then
    codex exec "${codex_flags[@]}" "${args[@]}" |
      clojure -Sdeps "${LAB_DEPS}" -M "$ROOT/dev/musn_stream.clj"
  else
    codex exec "${codex_flags[@]}" "${args[@]}" |
      clojure -Sdeps "${LAB_DEPS}" -M "$ROOT/dev/lab_stream_codex.clj"
  fi
  pipe_status=("${PIPESTATUS[@]}")
  set -e
  status=${pipe_status[0]}
  if [[ "${pipe_status[1]-}" == "3" ]]; then
    pause_exit=true
    status=0
  fi
else
  set +e
  codex "${args[@]}"
  status=$?
  set -e
fi

mapfile -t matches < <(clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-select-session.clj" --since "$START_ISO" --cwd "$RUN_CWD")

if [[ ${#matches[@]} -eq 0 ]]; then
  echo "[lab] no Codex sessions found for $RUN_CWD since $START_ISO" >&2
  exit $status
fi

if [[ ${#matches[@]} -gt 1 ]]; then
  if [[ ! -t 0 ]]; then
    echo "[lab] warning: stdin is not a TTY; selecting first session (${matches[0]%%$'\t'*})" >&2
    selected="${matches[0]}"
  else
    echo "[lab] multiple sessions found:" >&2
    i=1
    for line in "${matches[@]}"; do
      echo "  $i) $line" >&2
      i=$((i + 1))
    done
    read -r -p "Select session number: " choice
    if [[ -z "${choice}" || "${choice}" -lt 1 || "${choice}" -gt ${#matches[@]} ]]; then
      echo "[lab] invalid selection" >&2
      exit $status
    fi
    selected="${matches[$((choice - 1))]}"
  fi
else
  selected="${matches[0]}"
fi

session_id="${selected%%$'\t'*}"
session_file="${selected#*$'\t'}"
lab_session_id="$session_id"
if [[ -n "$FORCED_SESSION_ID" ]]; then
  lab_session_id="$FORCED_SESSION_ID"
fi

if [[ -z "${session_id}" || -z "${session_file}" ]]; then
  echo "[lab] failed to parse selected session" >&2
  exit $status
fi

lab_export_args=(--session-file "$session_file" --repo-root "$RUN_CWD" --lab-root "$ROOT/lab")
if [[ "$lab_session_id" != "$session_id" ]]; then
  lab_export_args+=(--session-id "$lab_session_id")
fi
if $pause_exit; then
  echo "[lab] paused; skipping lab export" >&2
else
  clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-export.clj" "${lab_export_args[@]}"

  clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-aif-equip.clj" \
    --session-id "$lab_session_id" \
    --adapter fulab \
    --lab-root "$ROOT/lab"

  clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-summarize.clj" \
    --raw "$ROOT/lab/raw/${lab_session_id}.json"
fi

if $pause_exit; then
  echo "[lab] paused for clarification; resume with:" >&2
  echo "  fucodex --session-id ${lab_session_id} resume --last \"Clarify scope: ...\"" >&2
fi

exit $status
