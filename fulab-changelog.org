#+TITLE: FuLab Changelog
#+AUTHOR: Claude (fuclaude agent)
#+DATE: 2026-01-01
#+STARTUP: overview

* Overview

This changelog tracks work on the fuclaude/fucodex integration with FUTON3's
pattern-based control flow system. The goal is to build a live computational
notebook model where Claude agents clock in on patterns, document their
reasoning, and produce auditable proof trails.

** Clocked-in Pattern

Currently working under: *Prototype 4 — Trail & Proof-State Journal*

#+begin_quote
+ if: You want every check, dismissal, and new pattern idea to leave an auditable trail.
+ however: Trails are still general-purpose exploration logs, not proof-state journals.
+ then: Extend the trail schema with =:pattern/id=, =:obligation/id=, =:action/tags=,
  and =:delta/joy=, add rollups that show which devmap clauses advanced per day,
  and expose a =/musn/trails/proof= export for futon4 archives.
+ because: The whole point is to measure how daily practice advances the devmaps.
#+end_quote

* 2026-01-01 — Initial Session: futon3-claude Integration

** Context
Joe wanted to test the futon3-claude capability from Emacs. We debugged and
extended the integration to get it working.

** What We Built

*** Fixed futon3-claude.el bootstrap issues
- =my-tatami--clojure= was undefined; set to ="clojure"= (not ="clj"= to avoid rlwrap)
- Loaded =futon3-bridge.el= and =futon3-claude.el= after setting the variable

*** Fixed streaming output format (f2/claude.clj)
- Changed =--output-format json= to =--output-format stream-json --verbose=
- Updated =process-output-line!= to handle stream-json event types:
  - =system= (init), =assistant= (message), =result=, =error=
- Added =extract-assistant-text= helper for nested message format

*** Added event polling infrastructure
- Added =:events-log= atom to session state for buffered event retrieval
- Added =get-events= function with offset support
- Added =/claude/events/:session-id?offset=N= endpoint in ui.clj
- Updated Elisp polling to fetch events incrementally, not all-from-zero

*** Cleaned up duplicate output
- Suppressed =session/started= (header already printed)
- Suppressed =session/result= (=assistant/message= already shows response)

** Files Changed
- =src/f2/claude.clj= — stream-json format, event logging, get-events
- =src/f2/ui.clj= — events endpoint with offset parsing
- =contrib/futon3-claude.el= — event polling, insert-event handlers

** Design Discussion: Session Management Architecture

*** Current State
Each =my-futon3-claude-run= spawns a fresh =claude --print= process. Single
prompt/response exchange, then exit.

*** Future Direction
- Use =--resume= for multi-turn conversations
- Session registry mapping futon3 session IDs to Claude CLI session IDs
- =my-futon3-claude-continue= command for follow-ups

*** Key Insight
Instead of post-hoc capture (fuclaude → lab-export-claude.clj), run Claude as
"Clojure agents" for real-time streaming stats and immediate XTDB writes.
This makes fu-lab more like live computational notebooks — cell-by-cell
execution = documentation.

** Design Discussion: Pattern-Based Control Flow

*** The Vision
Agents (fuclaude) "clock in" on patterns, document pattern dependencies as they
work, and at commit time reference a proof trail of agreed patterns that
scaffold their inference steps.

*** MUSN Enforcement
Transactions against the database must be signed off against design patterns.
Agents can work freely, even invent new patterns, but commits require
pattern-justified proof trails.

*** Integration Points
- Prototype 4: Trail & Proof-State Journal (foundation)
- Prototype 5: Workday Instrumentation (=workday/submit= endpoint)
- Prototype 6: Pattern Creation Workbench (agents propose new patterns)

** Next Steps
1. Build session resume capability (=--resume=, session registry)
2. Design "clock in" protocol — how agents declare pattern intent
3. Wire proof trail export to XTDB (=:pattern/id=, =:obligation/id= on trail events)
4. Expose =/musn/trails/proof= for futon4 archives

* Backlog

** TODO Implement =--resume= support in f2/claude.clj
Capture Claude CLI session_id from result event, add =resume-session!= function.

** TODO Design clock-in protocol
What does it look like for an agent to declare pattern intent at session start?

** TODO Wire events to XTDB
Trail events should flow to futon1 with pattern/obligation metadata.

** TODO Expose =/musn/trails/proof= endpoint
Export proof-state journal for futon4 archives.

** TODO Codex stream refinements
Decide whether to surface =event_msg/agent_reasoning= or =response_item/reasoning= entries in the Codex UI/logs.

* 2026-01-01 — Fucodex Parity Scaffolding

** Clocked-in Pattern
- fulab/clock-in (intent: establish fucodex parity with f2/claude session handling)

** Pattern Dependencies
- fulab/pattern-dep (reused claude session flow as the dependency source)

** Work
- Created =src/f2/codex.clj= by mirroring the claude subprocess manager, switching defaults to codex.
- Added codex endpoints to =src/f2/ui.clj= for run/sessions/events/stream/cancel/approve/deny/input.
- Added codex resume support and session-id capture for parity with claude.
- Hardened codex stream-json parsing to accept likely variant keys/types.
- Added =contrib/futon3-codex.el= with session resume helpers and CLI session registry.
- Updated codex parsing to accept line-delimited JSON with =session_id= + =text= fields (no =type=).
- Extended codex parsing to accept =event_msg/agent_message= and =response_item/message= payloads with output_text.
- Added handling for =response_item/custom_tool_call_output= to emit tool result events.
- Added handling for =response_item/custom_tool_call= to emit tool call events.
- Added handling for =response_item/function_call= and =response_item/function_call_output= to emit tool call/result events.
- Added handling for Codex exec JSONL events (=thread.started=, =item.completed= agent_message).
- Switched Codex CLI invocation to =codex exec --json= (removes unsupported =--print= flags).
- Added =--skip-git-repo-check= to Codex CLI invocation for simpler runs outside repos.
- Smoke-tested Codex run + resume via emacsclient with the new CLI invocation.
- Committed fucodex parity changes (commit =52ed25f=).

** Artifacts
- =src/f2/codex.clj=
- =src/f2/ui.clj=
- =contrib/futon3-codex.el=

** Clock-Out Summary
- status: partial (Codex exec JSONL works; tool event types beyond custom_tool_call/function_call still unverified)
- next: decide whether to pass =--skip-git-repo-check= or require repo cwd in the client.
