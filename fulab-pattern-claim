#!/usr/bin/env bash
set -euo pipefail

# fulab-pattern-claim: Write PUR/PSR claim events into lab sessions
# Usage:
#   fulab-pattern-claim --session-id ID --kind pur|psr|proposal
#   fulab-pattern-claim --session-id ID --kind psr --decision-id DECISION
#   fulab-pattern-claim --session-id ID --stdin < record.edn
#   fulab-pattern-claim --session-id ID --kind pur --certify-commit --repo-root "$PWD"

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DEPS='{}'

usage() {
  echo "Usage: fulab-pattern-claim --session-id ID --kind pur|psr|proposal [--decision-id ID] [--supporting-trail CSV] [--proposal-status STATUS] [--reviewer-notes CSV] [--stdin] [--print-only] [--certify-commit] [--repo-root PATH]"
  echo "Writes a PUR/PSR/proposal claim event into lab/sessions/<id>.edn (append-only)."
}

SESSION_ID=""
SESSION_FILE=""
LAB_ROOT="$ROOT/lab"
KIND=""
DECISION_ID=""
STDIN=false
PRINT_ONLY=false
CERTIFY_COMMIT=false
REPO_ROOT=""
SUPPORTING_TRAIL=""
PROPOSAL_STATUS=""
REVIEWER_NOTES=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --session-id)
      SESSION_ID="$2"; shift 2;;
    --session-file)
      SESSION_FILE="$2"; shift 2;;
    --lab-root)
      LAB_ROOT="$2"; shift 2;;
    --kind)
      KIND="$2"; shift 2;;
    --decision-id)
      DECISION_ID="$2"; shift 2;;
    --supporting-trail)
      SUPPORTING_TRAIL="$2"; shift 2;;
    --proposal-status)
      PROPOSAL_STATUS="$2"; shift 2;;
    --reviewer-notes)
      REVIEWER_NOTES="$2"; shift 2;;
    --stdin)
      STDIN=true; shift;;
    --print-only)
      PRINT_ONLY=true; shift;;
    --certify-commit)
      CERTIFY_COMMIT=true; shift;;
    --repo-root)
      REPO_ROOT="$2"; shift 2;;
    --help|-h)
      usage; exit 0;;
    *)
      echo "Unknown option: $1" >&2
      usage; exit 1;;
  esac
done

clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-pattern-claim.clj" \
  ${SESSION_ID:+--session-id "$SESSION_ID"} \
  ${SESSION_FILE:+--session-file "$SESSION_FILE"} \
  --lab-root "$LAB_ROOT" \
  ${KIND:+--kind "$KIND"} \
  ${DECISION_ID:+--decision-id "$DECISION_ID"} \
  ${SUPPORTING_TRAIL:+--supporting-trail "$SUPPORTING_TRAIL"} \
  ${PROPOSAL_STATUS:+--proposal-status "$PROPOSAL_STATUS"} \
  ${REVIEWER_NOTES:+--reviewer-notes "$REVIEWER_NOTES"} \
  $(if $STDIN; then echo --stdin; fi) \
  $(if $PRINT_ONLY; then echo --print-only; fi) \
  $(if $CERTIFY_COMMIT; then echo --certify-commit; fi) \
  ${REPO_ROOT:+--repo-root "$REPO_ROOT"}
