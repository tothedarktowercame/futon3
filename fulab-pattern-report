#!/usr/bin/env bash
set -euo pipefail

# fulab-pattern-report: Report PUR/PSR coverage for a session
# Usage:
#   fulab-pattern-report --session-id ID

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DEPS='{}'

usage() {
  echo "Usage: fulab-pattern-report --session-id ID"
  echo "Prints a concise PUR/PSR report for a session."
}

SESSION_ID=""
SESSION_FILE=""
LAB_ROOT="$ROOT/lab"
REPO_ROOT="$ROOT"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --session-id)
      SESSION_ID="$2"; shift 2;;
    --session-file)
      SESSION_FILE="$2"; shift 2;;
    --lab-root)
      LAB_ROOT="$2"; shift 2;;
    --repo-root)
      REPO_ROOT="$2"; shift 2;;
    --help|-h)
      usage; exit 0;;
    *)
      echo "Unknown option: $1" >&2
      usage; exit 1;;
  esac
done

clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-pattern-report.clj" \
  ${SESSION_ID:+--session-id "$SESSION_ID"} \
  ${SESSION_FILE:+--session-file "$SESSION_FILE"} \
  --lab-root "$LAB_ROOT" \
  --repo-root "$REPO_ROOT"
