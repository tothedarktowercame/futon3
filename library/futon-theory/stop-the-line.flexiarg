@flexiarg futon-theory/stop-the-line
@title Stop-the-Line Protocol
@sigils [ðŸŒ½/æ­¢]
@keywords stop, block, halt, invariant, failure, observe, verify, fix
@audience futon developers, on-call engineers
@tone analytic-foundational
@factor Keen investigation (dhammavicaya)
@references [futon-theory/error-hierarchy futon-theory/counter-ratchet futon-theory/agent-contract]

! conclusion:
  When invariants fail, block APPLY_CHANGE. Continue to allow OBSERVE and
  VERIFY until the issue is fixed. The line stops for production, not for
  diagnosis. Borrowed from Toyota Production System.

  + context: Invariant violations indicate system corruption or logic errors.
    Continuing to apply changes while invariants are failing compounds the
    problem. Stop-the-line halts destructive operations while keeping
    diagnostic operations available.

  + PROTOCOL:
    1. INVARIANT_CHECK fails
    2. System enters STOPPED state
    3. APPLY_CHANGE blocked for all sessions
    4. OBSERVE allowed (for diagnosis)
    5. VERIFY allowed (to test fixes)
    6. PROOF_COMMIT blocked until invariants pass
    7. On fix: INVARIANT_CHECK succeeds, line resumes

  + STOPPED-STATE-BEHAVIOR:
    - Read operations: ALLOWED
    - Query operations: ALLOWED
    - Diagnostic operations: ALLOWED
    - Write operations: BLOCKED
    - Commit operations: BLOCKED
    - Session clock-out: ALLOWED (with failure status)

  + NOTIFICATIONS:
    - Immediate: Alert to on-call with violation details
    - Contextual: Which invariant, which entity, what discrepancy
    - Actionable: Suggested diagnostic steps
    - Persistent: Status visible in health endpoints

  + RECOVERY:
    1. Diagnose: Use OBSERVE to understand the violation
    2. Fix: Apply correction (may require special override)
    3. Verify: Use VERIFY to confirm fix
    4. Resume: Invariants pass, line reopens

  + ANTI-PATTERNS:
    - Force-pushing changes despite violations
    - Disabling invariant checks to "get things working"
    - Logging violations but continuing anyway
    - Waiting for someone else to notice

  + RELATIONSHIP-TO-KAIZEN:
    Stop-the-line is not punishment; it's protection. Every stop is a
    learning opportunity. The goal is not to avoid stops but to fix the
    root cause so that specific stop never recurs.

  + BECAUSE:
    Continuing to run with broken invariants turns one problem into many.
    A single write to corrupt storage can cascade. Stopping early contains
    the blast radius and preserves diagnostic context.

  + NEXT-STEPS:
    next[Implement stopped-state middleware in futon1a]
    next[Add stop-the-line status to health endpoint]
