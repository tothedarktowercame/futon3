#!/usr/bin/env bash
set -euo pipefail

auto=false

if [[ $# -lt 1 ]]; then
  echo "usage: pattern-select [--auto] <pattern-id>... [note]" >&2
  exit 2
fi

if [[ "${1:-}" == "--auto" || "${1:-}" == "-a" ]]; then
  auto=true
  shift
fi

if [[ $# -lt 1 ]]; then
  echo "pattern-select: missing pattern id(s)" >&2
  exit 2
fi

if [[ "$auto" == "true" ]]; then
  candidates_raw=("$@")
  note=""
  pattern_raw=""
else
  pattern_raw="$1"
  shift
  candidates_raw=()
  note="${*:-}"
fi

sid="${FUTON3_MUSN_SESSION_ID:-}"
url="${FUTON3_MUSN_URL:-http://localhost:6065}"

if [[ -z "$sid" ]]; then
  echo "pattern-select: missing FUTON3_MUSN_SESSION_ID" >&2
  exit 2
fi

PATTERN_RAW="$pattern_raw" NOTE="$note" SID="$sid" URL="$url" AUTO="$auto" CANDIDATES="${candidates_raw[*]:-}" python3 - <<'PY'
import json
import os
import re
import sys
import urllib.request

auto = os.environ.get("AUTO", "").lower() == "true"
pattern = os.environ.get("PATTERN_RAW", "")
candidates_raw = os.environ.get("CANDIDATES", "").split()

def normalize(pat):
    if pat.startswith("library/"):
        pat = pat[len("library/"):]
    return pat

def validate(pat):
    if not re.match(r"^[a-z0-9._-]+/[a-z0-9._-]+$", pat or ""):
        print(f"pattern-select: invalid pattern id '{pat}'", file=sys.stderr)
        sys.exit(2)

if auto:
    candidates = [normalize(p) for p in candidates_raw if p]
    if not candidates:
        print("pattern-select: missing candidates for --auto", file=sys.stderr)
        sys.exit(2)
    for pat in candidates:
        validate(pat)
else:
    pattern = normalize(pattern)
    validate(pattern)
    candidates = [pattern]

note = os.environ.get("NOTE", "")
sid = os.environ.get("SID", "")
url = os.environ.get("URL", "").rstrip("/")
helper_mode = os.environ.get("FUTON3_MUSN_HELPER_MODE", "").lower()

def post(path, payload):
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(url + path, data=data, method="POST")
    req.add_header("Content-Type", "application/json")
    with urllib.request.urlopen(req, timeout=2) as resp:
        raw = resp.read().decode("utf-8") or "{}"
        return json.loads(raw)

try:
    if helper_mode == "stream":
        result = {"ok": True}
        if not auto:
            result["chosen"] = pattern
        print(json.dumps(result))
        raise SystemExit(0)
    state = post("/musn/session/state", {"session/id": sid})
    turn = (state.get("state") or {}).get("turn")
    if not turn:
        raise RuntimeError("missing turn in session state")

    reason = {"mode": "read", "source": "explicit"}
    if auto:
        reason["source"] = "auto"
    if note:
        reason["note"] = note

    payload = {
        "session/id": sid,
        "turn": int(turn),
        "candidates": candidates,
        "reason": reason,
    }
    if not auto:
        payload["chosen"] = pattern
    resp = post("/musn/turn/select", payload)
    if not resp.get("ok", True):
        raise RuntimeError(f"musn error {resp}")

    result = {"ok": True, "turn": int(turn)}
    if not auto:
        result["chosen"] = pattern
    print(json.dumps(result))
except Exception as exc:
    print(json.dumps({"ok": False, "error": str(exc)}))
    sys.exit(0)
PY
