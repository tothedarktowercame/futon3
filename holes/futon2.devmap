@multiarg futon2/devmap
@title FUTON2 Development Map
@audience futon-devs, simulation-agents, future-you
@tone formal-analytic
@style roadmap
@allow-new-claims true
@length any
@factor Energy (viriya)
@IFR: FUTON2 is the viriya (energy) chamber: a narratable Active Inference engine whose ants are first demonstrators for AIF agent species that will eventually crawl FUTON1 graph memory, export state to higher futons, and turn insight into kinetic practice across the network.
@state Ant sim + AIF loop run end-to-end with analyzer hooks, and cyber-ants can
swap in for the classic faction via Futon3-derived patterns. Architecture
baseline documented in stack-baseline.md. Observation property tests strong
(440+ iterations). Hunger/tau goldens recorded (6 scenarios). Policy goldens
recorded (5 scenarios). Gaps: formal semantics docs and white-space tests
missing.
@next Formalize micro-step semantics in doc/trace-semantics.md, update README observation vector, add white-space property tests, expand policy goldens to 10 scenarios.


! instantiated-by: Prototype 0 ‚Äî AIF Stack Baseline (observe ‚Üí perceive ‚Üí affect ‚Üí core) [üåù/Âõõ üêú/Âü∫]
  + context: FUTON2 runs a full Active Inference loop in the ant war-game, wiring `ants.aif.observe`, `ants.aif.perceive`, `ants.aif.affect`, and `ants.aif.core` into one tick-by-tick pipeline.
  + if: You want a stable story that shows how observation, prediction errors, precision, and actions integrate per tick.
  + however: Modules are individually solid but no single document freezes hunger/tau semantics or traces the whole stack.
  + then: Capture a top-level architecture note from sensory keys through world updates, lock current hunger and predictive micro-step parameters, and add four golden AIF microtraces.
  + because: A documented baseline prevents accidental drift before you optimise policy, analyzers, or mechanics.
  + evidence:
    - `futon2/doc/stack-baseline.md` (76 lines): Documents 5-stage pipeline (observe‚Üíperceive‚Üíaffect‚Üípolicy‚Üíact),
      locks baseline parameters (max-steps=4, alpha=0.45, beta=0.28), lists observation vector ABI.
    - `futon2/src/ants/aif/core.clj` (209 lines): `aif-step()` orchestrates full tick, `default-aif-config` defines
      all nested config (preferences, precision, actions, efe, modes).
    - `futon2/src/ants/aif/observe.clj` (185 lines): `g-observe()` normalizes 14 channels to [0,1].
    - `futon2/src/ants/aif/perceive.clj` (165 lines): Multi-step predictive coding with trace output.
    - `futon2/src/ants/aif/affect.clj` (240 lines): `tick-hunger()`, `hunger->tau()`, `modulate-precisions()`, `update-tau()`.
    - `futon2/src/ants/aif/policy.clj` (841 lines): EFE-based action selection with mode-conditioned biases.
    - `futon2/doc/trace/single_tick.edn` + `futon2/doc/trace/single_tick.svg`: Deterministic trace artifact + plot.
    - `futon2/test/resources/goldens/microtraces.edn`: 4 golden perception traces (baseline, hungry-near-enemy,
      sated-on-trail, homebound-low-pher).
  + next-evidence:
    - `doc/trace-semantics.md` explaining micro-step semantics and why errors are 0.0 in goldens.
    - `doc/hunger-tau-coupling.md` documenting when update-tau fires vs perceive-internal hunger updates.
    - 4 complete tick traces with commentary (forage, return, explore, defend scenarios).

! instantiated-by: Prototype 1 ‚Äî Observation Layer Hardening [üç≤/Áî∞ üåù/Âõõ]
  + context: `g-observe` normalises sensory evidence (food, pheromones, proximity, novelty, reserves) into the vectors passed downstream.
  + if: You want deterministic observations across seeds and a nailed-down vector ABI for later ML.
  + however: Normalisation bounds and neighbour logic assumptions are scattered across helpers.
  + then: Write property tests that enforce 0‚Äì1 ranges, document the `sense->vector` ordering, and add edge-case tests for grid borders, max-distance tweaks, and degenerate pheromone fields.
  + because: Reliable observations keep perception and policy stable no matter the world configuration.
  + evidence:
    - `futon2/test/ants/aif/observe_test.clj` (207 lines): Property tests + unit tests.
      - `g-observe-values-clamped`: 200 random worlds, all 16 keys verified ‚àà [0,1].
      - `g-observe-border-neighbor-means`: 120 iterations testing edge/corner calculations.
      - `degenerate-field-normalizes-to-zero`: Handles max-food=0 gracefully.
      - `sense-vector-ordering`: Locks 14-element vector ABI.
    - `futon2/src/ants/aif/observe.clj`: `clamp01()`, `normalize()` enforce bounds; all channels
      pass through normalization before return (lines 161-177).
    - `futon2/doc/stack-baseline.md` (lines 7-9): Lists observation ABI ordering.
    - `futon2/README.md` (lines 88-93): Documents sense‚Üívector keys (needs update: lists 13, actual is 14).
  + next-evidence:
    - `doc/observation-spec.md` listing all normalization bounds (max-food, max-pher, max-dist, max-reserve).
    - White-space detection property tests (`:white?` field currently untested).
    - Documentation of 8-neighborhood offset logic.

! instantiated-by: Prototype 2 ‚Äî Predictive Coding Microcycle Clarity [üôá/‰π° üòª/Âèâ]
  + context: Perception performs multi-step updates of mu, tau, Pi-o, goals, and weighted errors with annealing.
  + if: You want inspectors (or future Arxana bridges) to understand belief updates.
  + however: Hunger updates, sensory prediction, and error accumulation are interwoven without a canonical trace.
  + then: Publish a single-tick perception trace with plots of hunger, tau, and error per micro-step, and formalise an interface for extracting a mu/precision snapshot.
  + because: Clear cycles make later integrations with futon4 symbolic memory far easier.
  + evidence:
    - `test/resources/goldens/microtraces.edn` (24 lines): 4 golden scenarios with per-step traces.
      - `:baseline`: h 0.66‚Üí0.79, tau 1.47‚Üí0.81 over 4 steps.
      - `:hungry-near-enemy`: h jumps to 1.0, tau floors.
      - `:sated-on-trail`: h stays low 0.22‚Üí0.33, tau peaks 2.06‚Üí1.5.
      - `:homebound-low-pher`: h 0.55‚Üí1.0, tau drops 1.76‚Üí0.33.
    - `test/ants/aif/microtrace_regression_test.clj` (80 lines): Runs 4 scenarios through `aif-step`,
      compares `:perception :trace` to golden, locks baseline parameters.
    - `tools/trace_tick.clj` (151 lines): Generates `doc/trace/single_tick.edn` + SVG plot.
    - `doc/trace/single_tick.svg`: Renders tau (red), h (blue), error (purple) with legend.
    - `src/ants/aif/perceive.clj` (lines 133-164): Loop outputs `{:tau, :h, :error}` per micro-step.
  + next-evidence:
    - `doc/trace-semantics.md` formalizing micro-step semantics (why errors are 0.0, annealing formula).
    - Goal-bias mechanism documented and tested (blending toward home/enemy based on cargo).

! instantiated-by: Prototype 3 ‚Äî Hunger & Precision Dynamics Goldens [üí´/ÂÖ≠ üî•/È§ì]
  + context: Functions such as `tick-hunger`, `update-hunger`, `update-tau`, and `modulate-precisions` control the most sensitive dynamics.
  + if: You want reproducible affective behaviour that survives refactors.
  + however: There are no golden tests for tau evolution, hunger saturation, or reserve-driven adjustments.
  + then: Record six golden sequences (normal, starvation, overstimulation, heavy-cargo, high-risk, high-ingest) and lock expected tau floors/caps for each.
  + because: Once goldens exist, small tune-ups stop breaking entire colony behaviour.
  + evidence:
    - `test/resources/goldens/hunger_tau.edn` (163 lines): 6 golden sequences as specified.
      - `:normal`: h=0.42‚Üí0.427‚Üí0.233, tau=2.076 (strong feeding effect).
      - `:starvation`: h=0.88‚Üí0.896‚Üí0.887, tau FLOORS at 0.605 (exploitation mode).
      - `:overstimulation`: h=0.50‚Üí0.506‚Üí0.262, tau PEAKS at 2.011 (exploration mode).
      - `:heavy-cargo`: cargo=0.95, h=0.58‚Üí0.961, tau FLOORS at 0.597 (load stress).
      - `:high-risk`: h=0.60‚Üí0.671‚Üí0.649, tau=1.14 (moderate modulation).
      - `:high-ingest`: h=0.70‚Üí0.67‚Üí0.185, tau PEAKS at 2.18 (strong relief).
    - `test/ants/aif/hunger_regression_test.clj` (29 lines): Loads 6 scenarios, evaluates
      tick-hunger ‚Üí update-hunger ‚Üí hunger->tau ‚Üí modulate-precisions, compares to golden.
    - `tools/hunger_goldens.clj` (75 lines): Generator script for golden file.
    - `README.md` (lines 117-129): Documents hunger config parameters and defaults.
  + next-evidence:
    - `doc/hunger-goldens-guide.md` explaining behavioral regime each scenario represents.
    - SVG plots for hunger_tau trajectories (like trace_tick.clj does for microtraces).
    - Tau-floor/tau-cap assertions added to regression test (currently equality-only).
    - Boundary saturation tests (e.g., h=0.99 + 0.1 delta ‚Üí clamps to 1.0).

! instantiated-by: Prototype 4 ‚Äî Policy Layer Surfacing [üç≤/‰π° üòª/‰ª£]
  + context: `ants.aif.policy` selects actions using EFE metrics while `attach-policy-diagnostics` emits traces.
  + if: You want reproducible policy choices under controlled sensory inputs.
  + however: There is no standalone harness that feeds synthetic mu/observation pairs.
  + then: Build `(eval-policy mu prec obs config)` as a harness and add golden action rankings for ten canonical scenarios (e.g. rich food, enemy close, starvation risk).
  + because: Stabilised policies are mandatory before benchmarking or bridging into futon1 salience services.
  + evidence:
    - `test/resources/goldens/policy_harness.edn`: 5 golden scenarios with action rankings.
      - `:forage-normal`: Empty-handed, good food signal ‚Üí forage preferred.
      - `:loaded-homebound`: High cargo, near home ‚Üí return preferred.
      - `:white-space-scout`: No signals, exploring ‚Üí pheromone preferred.
      - `:deficit-colony`: Low reserves, high hunger ‚Üí return prioritized.
      - `:maintain-pheromone`: Good trail, near home ‚Üí pheromone preferred.
      Each includes: p (probability), G (free energy), risk, ambiguity, info, colony, survival, action-cost.
    - `tools/policy_harness.clj` (128 lines): Generator for 5 canonical scenarios.
    - `test/ants/aif/policy_harness_test.clj` (20 lines): Loads scenarios, runs `eval-policy`,
      compares rankings to golden.
    - `test/ants/aif/policy_test.clj` (187 lines): Comprehensive behavioral tests
      (shape, preference coupling, starvation tau clamping, nest action filtering).
    - `src/ants/aif/policy.clj`: `eval-policy()` function exists (deterministic ranking harness).
  + next-evidence:
    - Expand to 10 canonical scenarios as specified in devmap (currently 5).
    - Document EFE component formulas (risk, ambiguity, info, colony, survival) in `doc/policy-spec.md`.

! instantiated-by: Prototype 5 ‚Äî World Mechanics Contract (war.clj) [üéë/‰π¶ üëï/Â∑≤]
  + context: The simulator handles evaporation, movement, gather/deposit, pheromone dynamics, hunger propagation, reserves, and termination.
  + if: You want FUTON2 to be a reliable agent-environment backend.
  + however: Movement heuristics, gather thresholds, and white-streak rules are powerful yet lightly documented.
  + then: Document all invariants (pheromone caps, grid bounds, gather limits), seed movement decisions for determinism, and split movement modes into testable units.
  + because: A clear contract keeps the world trustworthy when other prototypes depend on it for episodes.

! instantiated-by: Prototype 6 ‚Äî Live Analyzer & Pivot Stream Stabilisation [üö¢/Â∑≤ üê≤/Êó†]
  + context: The live analyzer consumes pivot events, computes EWMA metrics, detects starvation spirals, and prints mode transitions.
  + if: You want analyzer outputs to feed futon3 evaluations or futon4 reflexive agents.
  + however: Pivot schemas are implicit and analyzer assumptions are undocumented.
  + then: Freeze a versioned pivot-row schema, add tests for required keys (:act, :mode, :cargo, :ing, etc.), and ship an example analyzer plugin for futon4.
  + because: Pivot streams are FUTON2‚Äôs event bus and must behave like a stable ABI.

! instantiated-by: Prototype 7 ‚Äî Classic vs AIF Benchmark Suite [üóø/‰∏â üêú/‰∏çË¶Å]
  + context: Benchmark scripts compare classic ants to AIF runs across scores, durations, and G-ema.
  + if: You want formal behavioural comparisons rather than anecdotes.
  + however: Only three preset scenarios exist and there is no variance analysis.
  + then: Add parametrised benchmarks spanning grid sizes, pheromone decay, hunger burn, and tau floors; capture plots and golden CSVs.
  + because: FUTON2 should function as a scientific system with reproducible metrics.

! instantiated-by: Prototype 8 ‚Äî External Control & Episode Export [üì§/‰∫à üö¢/Â∑≤]
  + context: `simulate` drives the war sim but offers no external stepping API.
  + if: You want futon3 or futon4 to request ‚Äúgive me N steps with this config.‚Äù
  + however: Stepping remains tied to the CLI and HUD.
  + then: Expose `(futon2.step world n {:emit-pivot? true})`, add EDN exports of full episodes, and keep pivot batches consistent.
  + because: Exported episodes are critical for agent training, memory, and pattern extraction.

! instantiated-by: Prototype 9 ‚Äî futon1 ‚Üî futon2 Alignment Layer [üëé/Âàä üë≠/‰∫å]
  + context: FUTON1 emits focus headers and salience; FUTON2 emits percept/action streams.
  + if: You want the ants to act as embodied readers + writers of futon1‚Äôs graph.
  + however: there is no shared dictionary between entities/intents and colony modes, so exports are useless to FUTON1.
  + then: define the crosswalk (entities ‚Üî colonies, intents ‚Üî behaviours), publish an export schema, and prove it by replaying one colony while FUTON1 ingests the stream and surfaces it back to users.
  + because: a working bridge proves ants can reason over the same facts as the rest of the stack.

! instantiated-by: Prototype 10 ‚Äî Curriculum Scenarios & AIF Behaviour Cards [üé¥/‰π° üì§/‰∫à]
  + context: The current war scenario is rich but single-purpose.
  + if: You want FUTON2 to double as a pedagogical engine for Active Inference.
  + however: There is no named curriculum.
  + then: Create behaviour cards (home-return, starvation spiral, over-exploration, defensive lattice, greedy gatherer collapse), simulate each with fixed seeds, and export the episodes.
  + because: These cards seed pattern extraction and future training systems.

! instantiated-by: Prototype 11 ‚Äî AIF Agent Debugger & Mu/Precision Visualiser [üòª/Áî± üö¢/‰∏Ä]
  + context: Pivot logs are textual and require manual parsing.
  + if: You want interactive introspection of mu vectors, tau evolution, and weighted errors.
  + however: No visualiser or ‚Äúfollow Alice‚Äù mode exists.
  + then: Build a Clerk notebook (or similar) that plots tau, hunger, errors, and pivot timelines, plus a mode that traces one agent‚Äôs full mu timeline.
  + because: Visual insight accelerates iteration and debugging.

! instantiated-by: Prototype 12 ‚Äî Year-End Packaging & Story [üåΩ/Êú´]
  + context: FUTON2 must read as a coherent simulation layer to partners and future prototypes.
  + if: You want it to be adoptable as a research simulator.
  + however: The codebase is powerful but intimidating without a unifying story.
  + then: Package the release with a top-level README, whitepaper, stepping API, goldens, and versioned pivot schema.
  + because: Strong packaging turns FUTON2 into a reusable, inspectable module inside the full FUTON stack.

! instantiated-by: Prototype 13 ‚Äî Graph Memory Adapter & Agent ABI [üëé/‰πÉ ‚û∞/Ë∞É]
  + context: FUTON1 now offers a documented graph-memory API; FUTON2 needs to speak it to graduate beyond the sandbox.
  + if: You want ants to be the first drop-in ‚ÄúAIF agent‚Äù that reads fact graphs and writes back its beliefs.
  + however: percepts/actions remain locked to grid coordinates, so nothing maps to FUTON1 entity IDs or relation semantics.
  + then: design a bidirectional adapter (percepts ‚Üí graph facts, graph cues ‚Üí priors), version the ABI, and replay a colony run that exports beliefs into FUTON1 salience tables. Treat FUTON3 proof trails as ‚Äúhuman pheromone lines‚Äù: export the canonical trail EDN (pattern IDs, fruits/orbs, joy deltas) into FUTON1, expose them via the adapter so analyzers ingest them as missions, and log agent runs as trail-style payloads (mission, outcome, energy delta) back into MUSN so FUTON3 records ‚Äúagent proofs.‚Äù
  + because: once the adapter honours shared trail/pheromone energy, human proofwork and AIF runs guide each other through the same mission record instead of bespoke glue.

! instantiated-by: Prototype 14 ‚Äî Viriya Field & Social Activation Metrics [‚ö°Ô∏è/‰π† üêú/Âä≤]
  + context: FUTON2 carries the Factor of Awakening ‚Äúenergy/viriya‚Äù: vigor, commitment, and kinetic practice.
  + if: You want simulations to reflect and inform real social activation‚Äînetworked collaboration, shared commitments, and practice loops across humans + agents.
  + however: Current metrics stop at hunger/tau; nothing measures vigor, pledge strength, or coordination throughput.
  + then: Introduce viriya indicators (e.g., colony activation score, pledge adherence, transfer of trails into collaborative tasks), log them per episode, and export them so futon3/futon7 can read ‚Äúenergy health.‚Äù
  + because: Tying the simulation to viriya turns FUTON2 into a practice accelerator instead of a curiosity.

! instantiated-by: Prototype 15 ‚Äî Sandbox Bridge & Presence Interface [üåÄ/ÂÜÖ üôÖ/Âàä]
  + context: FUTON3 now emphasises flexiformal proofwork but still hosts multi-user rooms and SAFE REPL affordances.
  + if: You want AIF agents (ants and successors) to inhabit those rooms, receive room/talk updates, and emit actions back into the simulation.
  + however: No interface maps MUSN room events/presence into FUTON2 percepts, nor do ants announce themselves inside FUTON3.
  + then: Define a bidirectional ‚Äúpresence bus‚Äù (rooms ‚Üí observation cues, agent actions ‚Üí MUSN events), add authentication so only designated colonies bridge, and ship a demo where ants report discoveries into a FUTON3 trail.
  + because: This proves that AIF agents can show up wherever proofwork happens, not just inside a war grid.

! instantiated-by: Prototype 16 ‚Äî Lobby Bus & MUSN Intake [üôÖ/Êó† üí§/Â∑≤]
  + context: FUTON3 runs with MUSN as a shared graph and chatgpt-shell as a HUD, but ChatGPT-API currently has only conversational access and no principled way to commit events back into MUSN.
  + if: You want ChatGPT-API to propose or make *persistent* updates (breach logs, paramitƒÅ orbs, devmap notes, pattern instantiations) without giving it full god-mode over the stack.
  + however: There is no explicit one-room ‚ÄúLobby‚Äù where HUD traffic is normalised into MUSN events, no single-writer policy, and no clear schema for what counts as an escalated, storable event versus transient chatter.
  + then: Create a dedicated Lobby room in MUSN with a minimal intake schema (`:musn/events` envelopes on an escalated bus), grant exactly one writer identity (the chatgpt-shell / FUTON3 service account), and implement a Clojure bridge that (a) parses HUD EDN, (b) validates and timestamps Lobby events, and (c) transacts them into the MUSN graph as append-only nodes that downstream agents can subscribe to.
  + because: This proves that a single HUD-bound agent can safely ‚Äústep into‚Äù MUSN through a constrained door‚Äîacting as a semi-privileged clerk rather than an all-powerful daemon‚Äîand sets the pattern for later extending the presence bus (Prototype 15) to multiple rooms and multiple authenticated agent writers.
  + example: To assist the user with time management, ChatGPT-API offered: ‚ÄúDo you want breaches auto-logged if you‚Äôre still active at 22:10?‚Äù  At present there‚Äôs no way for ChatGPT to *actually* log such breaches anywhere. Rather than assuming all escalated events must be elicited in the same way at all times, allow `set-user-system-prompt` in futon3‚Äôs `aob-chatgpt.el` to switch between modes (e.g. `:normal`, `:breach-logging`) under external control (cron, or a MUSN agent). ChatGPT-API can then *propose* mode shifts or breach events via the Lobby, while the MUSN side decides which proposals to enact.
  + example2: While reviewing a day‚Äôs evidence, ChatGPT-API proposes a structured ‚ÄúparamitƒÅ reflection‚Äù event via the Lobby:
    {:musn/events
      [{:event/type     :paramita/reflection
        :event/paramita :equanimity
        :event/notes    "User can apply 9 of Cups to understand the source of a workplace frustration."
        :event/request  :musn.store!}]}
  This safely introduces reflective practice artefacts into MUSN without conflating them with actual
  mode changes or breach logging. It demonstrates that the Lobby is not only
  for operational concerns (like curfew rules) but also for epistemic/ritual
  artefacts that support the broader FUTON practice space.  The HUD then renders a subtle, clickable banner: Reflection exercise suggested ‚ñ∏

! instantiated-by: Prototype 16 ‚Äî Wisdom Trail Harvest & Pattern Seeding [‚û∞/Âéª üëé/Ê∞è]
  + context: FUTON3 trails now record which patterns were checked or advanced during human work sessions.
  + if: You want FUTON2 analyzers to ingest those trails, compare them to colony behaviour, and commission new agent goals.
  + however: There is no ingestion path for trail EDN, nor a feedback loop that says ‚Äúagents, go gather evidence for Pattern X.‚Äù
  + then: Add a `trail->mission` translator that turns FUTON3 proof deltas into FUTON2 goal queues, plus a reporting job that shows how agent runs affected subsequent checks.
  + because: Shared missions keep the ‚Äúenergy‚Äù loop tight between simulations and human proofwork.
