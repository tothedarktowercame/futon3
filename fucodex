#!/usr/bin/env bash
set -euo pipefail

if [[ -z "${BASH_VERSION-}" ]]; then
  exec bash "$0" "$@"
fi

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAB_DEPS='{:deps {org.clojure/data.json {:mvn/version "2.5.0"}
                  futon2/futon2 {:local/root "../futon2"}}}'
START_ISO=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
RUN_CWD="$(pwd)"
export PATH="$ROOT/scripts:$PATH"

LIVE=false
PATTERNS=""
CHOSEN=""
CLOCK_IN=""
FORCED_SESSION_ID=""
AIF_CONFIG=""
AIF_EXPLAIN=false
AIF_EXPLAIN_PATH=""
AIF_SELECT=false
PROPOSAL_HOOK=false
EXPLORE=false
EXPLORE_CATALOG=""
EXPLORE_HOTWORDS=""
EXPLORE_NAMESPACES=""
EXPLORE_LIMIT="4"
EXPLORE_PROMPT_FILE="docs/codex-exploratory-mission.md"
HUD_MODE=false
HUD_INTENT=""
SKIP_GIT_CHECK=false
HUD_PRINT=false
HUD_SERVER="${HUD_SERVER:-http://localhost:5050}"

show_help() {
  cat <<'EOF'
Usage: fucodex [--live] [--patterns CSV] [--chosen PATTERN] [--clock-in PATTERN] [--session-id ID] [--aif-config PATH] [--aif-explain [PATH]]... [args...]

Options:
  -h, --help           Show this help.
  --live               Run Codex in live mode with lab streaming.
  --patterns CSV       Comma-separated patterns for the run manifest.
  --chosen PATTERN     Set chosen pattern (ignored when --clock-in is provided).
  --clock-in PATTERN   Add a clock-in pattern (repeatable or comma-separated; overrides --chosen).
  --session-id ID      Force a session id for stream/export/summary (skips selection).
  --aif-config PATH    EDN config file to tune AIF scoring parameters.
  --aif-explain [PATH] Explain AIF config with a worked example and exit.
  explore              Run the exploratory mission prompt (manual heuristic).
  --explore-catalog     Pattern catalog path (default: resources/sigils/patterns-index.tsv)
  --explore-hotwords    CSV list of hotwords to bias candidate selection.
  --explore-namespaces  CSV list of namespaces to consider.
  --explore-limit       Max candidates to select (default: 4).
  --explore-prompt      Prompt file to use (default: docs/codex-exploratory-mission.md).
  --aif-select          Let AIF choose the pattern (used in explore).
  --proposal-hook       Emit proposal draft when candidates are insufficient.
  --hud                 Enable HUD mode: seed patterns into prompt, parse response.
  --intent TEXT         Intent/goal for HUD pattern selection.
  --hud-print           Print HUD block before running codex.
  --hud-server URL      HUD server base URL (default: http://localhost:5050).

Examples:
  fucodex --live exec --prompt "Draft the summary"
  fucodex --live --patterns "ants/white-space-scout" --chosen ants/white-space-scout exec --prompt "Explain"
  fucodex --live --clock-in ants/white-space-scout --clock-in ants/pheromone-trail-tuner exec --prompt "Review"
  fucodex --live resume --last "Continue work"
  fucodex --aif-explain docs/aif/fulab-config.edn
  fucodex --aif-explain
  fucodex explore --explore-hotwords "aif,session,trace"
  fucodex exec --prompt "Non-live run"
  fucodex --hud --intent "implement schema" exec --prompt "Add belief-state schema"
EOF
}

args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_help
      exit 0;;
    --live)
      LIVE=true; shift;;
    --patterns)
      PATTERNS="$2"; shift 2;;
    --chosen)
      CHOSEN="$2"; shift 2;;
    --clock-in)
      if [[ -n "$CLOCK_IN" ]]; then
        CLOCK_IN="${CLOCK_IN},$2"
      else
        CLOCK_IN="$2"
      fi
      shift 2;;
    --session-id)
      FORCED_SESSION_ID="$2"; shift 2;;
    --aif-config)
      AIF_CONFIG="$2"; shift 2;;
    --aif-explain)
      AIF_EXPLAIN=true
      if [[ -n "${2-}" && "${2-}" != --* ]]; then
        AIF_EXPLAIN_PATH="$2"
        shift 2
      else
        shift
      fi;;
    explore)
      EXPLORE=true; shift;;
    --explore-catalog)
      EXPLORE_CATALOG="$2"; shift 2;;
    --explore-hotwords)
      EXPLORE_HOTWORDS="$2"; shift 2;;
    --explore-namespaces)
      EXPLORE_NAMESPACES="$2"; shift 2;;
    --explore-limit)
      EXPLORE_LIMIT="$2"; shift 2;;
    --explore-prompt)
      EXPLORE_PROMPT_FILE="$2"; shift 2;;
    --aif-select)
      AIF_SELECT=true; shift;;
    --proposal-hook)
      PROPOSAL_HOOK=true; shift;;
    --hud)
      HUD_MODE=true; shift;;
    --intent)
      HUD_INTENT="$2"; shift 2;;
    --hud-print)
      HUD_PRINT=true; shift;;
    --hud-server)
      HUD_SERVER="$2"; shift 2;;
    *)
      args+=("$1"); shift;;
  esac
done

if [[ "${CODEX_SKIP_GIT_REPO_CHECK-}" == "1" || "${CODEX_SKIP_GIT_REPO_CHECK-}" == "true" ]]; then
  SKIP_GIT_CHECK=true
fi

if $AIF_EXPLAIN; then
  explain_path="$AIF_EXPLAIN_PATH"
  if [[ -z "$explain_path" && -n "$AIF_CONFIG" ]]; then
    explain_path="$AIF_CONFIG"
  fi
  if [[ -n "$explain_path" ]]; then
    clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-aif-explain.clj" --config "$explain_path"
  else
    clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-aif-explain.clj"
  fi
  exit 0
fi

if $EXPLORE; then
  LIVE=true
  AIF_SELECT=true
  PROPOSAL_HOOK=true
  if [[ -z "$EXPLORE_CATALOG" ]]; then
    EXPLORE_CATALOG="resources/sigils/patterns-index.tsv"
  fi
  if [[ -z "$EXPLORE_NAMESPACES" ]]; then
    EXPLORE_NAMESPACES="ants,code-coherence,stack-coherence,devmap-coherence,contributing"
  fi
  if [[ -z "$PATTERNS" || -z "$CHOSEN" ]]; then
    read -r explore_chosen explore_candidates < <(clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-explore-candidates.clj" \
      --catalog "$EXPLORE_CATALOG" \
      --limit "$EXPLORE_LIMIT" \
      ${EXPLORE_HOTWORDS:+--hotwords "$EXPLORE_HOTWORDS"} \
      ${EXPLORE_NAMESPACES:+--namespaces "$EXPLORE_NAMESPACES"})
    if [[ -z "$PATTERNS" ]]; then
      PATTERNS="$explore_candidates"
    fi
    if [[ -z "$CHOSEN" && "$AIF_SELECT" != true ]]; then
      CHOSEN="$explore_chosen"
    fi
  fi
  if [[ ${#args[@]} -eq 0 ]]; then
    if [[ ! -f "$ROOT/$EXPLORE_PROMPT_FILE" ]]; then
      echo "[lab] explore prompt file not found: $EXPLORE_PROMPT_FILE" >&2
      exit 2
    fi
    prompt=$(awk 'BEGIN{inside=0} /^```/{if(inside){exit} else {inside=1; next}} inside{print}' "$ROOT/$EXPLORE_PROMPT_FILE")
    if [[ -z "$prompt" ]]; then
      echo "[lab] explore prompt missing fenced block in $EXPLORE_PROMPT_FILE" >&2
      exit 2
    fi
    args=("$prompt")
  fi
fi

if [[ -n "$CHOSEN" && -n "$CLOCK_IN" ]]; then
  echo "[lab] warning: --chosen is ignored when --clock-in is provided" >&2
fi

# HUD mode: inject pattern context into prompt
HUD_FILE=""
HUD_JSON_FILE=""
if $HUD_MODE; then
  HUD_ENDPOINT="${HUD_SERVER%/}/fulab/hud/format"
  HUD_PAYLOAD=$(HUD_INTENT="$HUD_INTENT" PATTERNS="$PATTERNS" EXPLORE_LIMIT="$EXPLORE_LIMIT" RUN_CWD="$RUN_CWD" python3 - <<'PY'
import json, os

intent = os.environ.get("HUD_INTENT", "")
patterns = os.environ.get("PATTERNS", "")
limit = os.environ.get("EXPLORE_LIMIT", "4")
try:
    limit = int(limit)
except ValueError:
    limit = 4

prototypes = [p for p in patterns.split(",") if p.strip()] if patterns else []

payload = {
    "intent": intent,
    "prototypes": prototypes,
    "pattern-limit": limit,
    "certify-commit": True,
    "repo-root": os.environ.get("RUN_CWD", os.getcwd()),
}

print(json.dumps(payload))
PY
)

  HUD_RESPONSE=$(curl -sS -X POST "$HUD_ENDPOINT" \
    -H "content-type: application/json" \
    -d "$HUD_PAYLOAD") || {
    echo "[fucodex] HUD server not reachable at $HUD_ENDPOINT" >&2
    exit 2
  }
  HUD_JSON_FILE="$(mktemp -t fucodex-hud-XXXXXX.json)"
  trap '[[ -n "${HUD_JSON_FILE-}" ]] && rm -f "$HUD_JSON_FILE"' EXIT
  printf "%s" "$HUD_RESPONSE" > "$HUD_JSON_FILE"

  if [[ -z "$PATTERNS" ]]; then
    HUD_PATTERNS=$(HUD_RESPONSE="$HUD_RESPONSE" python3 - <<'PY'
import json, os

raw = os.environ.get("HUD_RESPONSE", "")
try:
    data = json.loads(raw)
except Exception:
    data = {}

hud = data.get("hud", {}) or {}
candidates = hud.get("candidates", []) or []
ids = [c.get("id") for c in candidates if isinstance(c, dict) and c.get("id")]
print(",".join(ids))
PY
)
    if [[ -n "$HUD_PATTERNS" ]]; then
      PATTERNS="$HUD_PATTERNS"
    fi
  fi

  HUD_BLOCK=$(HUD_RESPONSE="$HUD_RESPONSE" python3 - <<'PY'
import json, os, sys

raw = os.environ.get("HUD_RESPONSE", "")
if not raw:
    sys.exit(1)
try:
    data = json.loads(raw)
except Exception:
    sys.exit(1)
if not data.get("ok"):
    sys.exit(2)
prompt = data.get("prompt", "")
if prompt:
    sys.stdout.write(prompt)
PY
)

  if [[ -z "$HUD_BLOCK" ]]; then
    echo "[fucodex] HUD server returned no prompt" >&2
    exit 2
  fi

  if $HUD_PRINT; then
    echo "$HUD_BLOCK"
  fi
  # Rebuild args with HUD prepended to prompt
  # For codex, the prompt is typically the last arg or after --prompt
  new_args=()
  for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[$i]}" == "--prompt" && $((i+1)) -lt ${#args[@]} ]]; then
      original_prompt="${args[$((i+1))]}"
      combined_prompt="${HUD_BLOCK}

User task: ${original_prompt}"
      new_args+=("--prompt" "$combined_prompt")
      ((i++))  # Skip the next element since we handled it
    elif [[ $i -eq $((${#args[@]}-1)) && "${args[$i]}" != --* && "${new_args[*]}" != *"--prompt"* ]]; then
      # Last arg without --prompt flag (bare prompt)
      combined_prompt="${HUD_BLOCK}

User task: ${args[$i]}"
      new_args+=("$combined_prompt")
    else
      new_args+=("${args[$i]}")
    fi
  done
  args=("${new_args[@]}")
  echo "[fucodex] HUD injected with ${HUD_INTENT:-unspecified} intent" >&2
fi

# Normalize --prompt usage for codex exec --json (expects bare prompt string).
if [[ ${#args[@]} -gt 0 ]]; then
  prompt_arg=""
  remaining_args=()
  for ((i=0; i<${#args[@]}; i++)); do
    if [[ "${args[$i]}" == "--prompt" && $((i+1)) -lt ${#args[@]} ]]; then
      prompt_arg="${args[$((i+1))]}"
      ((i++))
    else
      remaining_args+=("${args[$i]}")
    fi
  done
  if [[ -n "$prompt_arg" ]]; then
    if [[ ${#remaining_args[@]} -gt 0 ]]; then
      echo "[lab] warning: --prompt used; ignoring extra args for codex exec" >&2
    fi
    args=("$prompt_arg")
  fi
fi

if [[ -n "$FORCED_SESSION_ID" ]]; then
  export FUTON3_CODEX_SESSION_ID="$FORCED_SESSION_ID"
fi
if [[ -n "$HUD_SERVER" ]]; then
  export FUTON3_CODEX_SERVER_URL="$HUD_SERVER"
fi

if $LIVE; then
  if [[ ${#args[@]} -eq 0 ]]; then
    echo "[lab] --live requires a codex command (use 'exec \"...\"' or a subcommand)" >&2
    show_help
    exit 2
  fi
  if [[ "${args[0]-}" == "exec" ]]; then
    args=("${args[@]:1}")
  fi
  set -o pipefail
  clj_args=(--lab-root "$ROOT/lab")
  if [[ -n "$PATTERNS" ]]; then
    clj_args+=(--patterns "$PATTERNS")
  fi
  if [[ -n "$CHOSEN" ]]; then
    clj_args+=(--chosen "$CHOSEN")
  fi
  if [[ -n "$CLOCK_IN" ]]; then
    clj_args+=(--clock-in "$CLOCK_IN")
  fi
  if [[ -n "$FORCED_SESSION_ID" ]]; then
    clj_args+=(--session-id "$FORCED_SESSION_ID")
  fi
  if [[ -n "$AIF_CONFIG" ]]; then
    clj_args+=(--aif-config "$AIF_CONFIG")
  fi
  if [[ -n "$HUD_JSON_FILE" ]]; then
    clj_args+=(--hud-json "$HUD_JSON_FILE")
  fi
  if $AIF_SELECT; then
    clj_args+=(--aif-select)
  fi
  if $PROPOSAL_HOOK; then
    clj_args+=(--proposal-hook)
  fi
  codex_flags=(--json)
  if $SKIP_GIT_CHECK; then
    codex_flags+=(--skip-git-repo-check)
  fi
  if [[ ${#args[@]} -gt 0 && "${args[0]}" == -* ]]; then
    codex_flags+=(--)
  fi
  codex exec "${codex_flags[@]}" "${args[@]}" | clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab_stream_codex.clj" "${clj_args[@]}"
  status=${PIPESTATUS[0]}
else
  codex "${args[@]}"
  status=$?
fi

mapfile -t matches < <(clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-select-session.clj" --since "$START_ISO" --cwd "$RUN_CWD")

if [[ ${#matches[@]} -eq 0 ]]; then
  echo "[lab] no Codex sessions found for $RUN_CWD since $START_ISO" >&2
  exit $status
fi

if [[ ${#matches[@]} -gt 1 ]]; then
  if [[ ! -t 0 ]]; then
    echo "[lab] warning: stdin is not a TTY; selecting first session (${matches[0]%%$'\t'*})" >&2
    selected="${matches[0]}"
  else
    echo "[lab] multiple sessions found:" >&2
    i=1
    for line in "${matches[@]}"; do
      echo "  $i) $line" >&2
      i=$((i + 1))
    done
    read -r -p "Select session number: " choice
    if [[ -z "${choice}" || "${choice}" -lt 1 || "${choice}" -gt ${#matches[@]} ]]; then
      echo "[lab] invalid selection" >&2
      exit $status
    fi
    selected="${matches[$((choice - 1))]}"
  fi
else
  selected="${matches[0]}"
fi

session_id="${selected%%$'\t'*}"
session_file="${selected#*$'\t'}"
lab_session_id="$session_id"
if [[ -n "$FORCED_SESSION_ID" ]]; then
  lab_session_id="$FORCED_SESSION_ID"
fi

if [[ -z "${session_id}" || -z "${session_file}" ]]; then
  echo "[lab] failed to parse selected session" >&2
  exit $status
fi

lab_export_args=(--session-file "$session_file" --repo-root "$RUN_CWD" --lab-root "$ROOT/lab")
if [[ "$lab_session_id" != "$session_id" ]]; then
  lab_export_args+=(--session-id "$lab_session_id")
fi
clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-export.clj" "${lab_export_args[@]}"

clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-aif-equip.clj" \
  --session-id "$lab_session_id" \
  --adapter fulab \
  --lab-root "$ROOT/lab"

clojure -Sdeps "$LAB_DEPS" -M "$ROOT/dev/lab-summarize.clj" \
  --raw "$ROOT/lab/raw/${lab_session_id}.json"

exit $status
